# ğŸ® æœå†»å½±é™¢ 2.0 - é¡¹ç›®äº®ç‚¹å¢å¼ºæ–¹æ¡ˆ

<div align="center">

**åŸºäº Spring Cloud Alibaba çš„å½±è§†ç¤¾äº¤å¾®æœåŠ¡å¹³å°**

`å¾®æœåŠ¡æ¶æ„` `é«˜å¹¶å‘è®¾è®¡` `å®æ—¶é€šè®¯` `AIæ™ºèƒ½` `åˆ†å¸ƒå¼ç¼“å­˜` `å…¨æ–‡æ£€ç´¢`

</div>

> ğŸ“Œ æœ¬æ–‡æ¡£åŸºäºé¡¹ç›®å®é™…ä»£ç å®ç°ï¼Œæä¾›**å¯è½åœ°ã€å¯éªŒè¯ã€å¯å¤ç°**çš„æ¶æ„è®¾è®¡ä¸é¢è¯•è¡¨è¾¾ç­–ç•¥

---

## ğŸ“‘ ç›®å½•

- [ä¸€ã€é¡¹ç›®æ ¸å¿ƒäº®ç‚¹ï¼ˆç®€å†ç‰ˆï¼‰](#ä¸€é¡¹ç›®æ ¸å¿ƒäº®ç‚¹ç®€å†ç‰ˆ)
- [äºŒã€ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#äºŒç³»ç»Ÿæ¶æ„æ€»è§ˆ)
- [ä¸‰ã€åŠŸèƒ½äº®ç‚¹è¯¦è§£ï¼ˆREADMEç‰ˆï¼‰](#ä¸‰åŠŸèƒ½äº®ç‚¹è¯¦è§£readmeç‰ˆ)
- [å››ã€æŠ€æœ¯äº®ç‚¹æ·±åº¦å‰–æï¼ˆé¢è¯•ç‰ˆï¼‰](#å››æŠ€æœ¯äº®ç‚¹æ·±åº¦å‰–æé¢è¯•ç‰ˆ)
- [äº”ã€é¡¹ç›®éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ](#äº”é¡¹ç›®éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ)
- [å…­ã€å¦‚ä½•å‘é¢è¯•å®˜è®²è¿™ä¸ªé¡¹ç›®](#å…­å¦‚ä½•å‘é¢è¯•å®˜è®²è¿™ä¸ªé¡¹ç›®)
- [ä¸ƒã€é™„å½•](#ä¸ƒé™„å½•)

---

## ä¸€ã€é¡¹ç›®æ ¸å¿ƒäº®ç‚¹ï¼ˆç®€å†ç‰ˆï¼‰

> ğŸ’¡ **ä½¿ç”¨åœºæ™¯**ï¼šç®€å†é¡¹ç›®æè¿°ã€è‡ªæˆ‘ä»‹ç»æ—¶çš„ 30 ç§’ Pitch

### ğŸ¯ ç²¾ç®€ç‰ˆï¼ˆ3 å¥è¯ï¼Œé€‚åˆç®€å†ï¼‰

```
1. åŸºäº Spring Cloud Alibaba å¾®æœåŠ¡æ¶æ„ï¼Œé›†æˆ Nacos æœåŠ¡æ²»ç† + Sentinel é™æµç†”æ–­ + RocketMQ å¼‚æ­¥å‰Šå³°ï¼Œ
   å®ç°å½±è§†ã€ç¤¾åŒºã€IMã€AI å››å¤§æ ¸å¿ƒæ¨¡å—çš„é«˜å¯ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

2. è®¾è®¡å¹¶å®ç° Redis + Caffeine å¤šçº§ç¼“å­˜ã€WebSocket å®æ—¶é€šè®¯ã€ES æ··åˆæ£€ç´¢ï¼ˆBM25 + å‘é‡è¯­ä¹‰ï¼‰ç­‰æ ¸å¿ƒèƒ½åŠ›ï¼Œ
   ç³»ç»Ÿæ”¯æ’‘ä¸‡çº§å¹¶å‘è¿æ¥ï¼Œç¼“å­˜å‘½ä¸­ç‡ 95%+ï¼Œæœç´¢å“åº” < 100msã€‚

3. è½åœ° LangChain4j å¤š AI æä¾›å•†è·¯ç”±ä¸æ•…éšœè½¬ç§»æœºåˆ¶ï¼Œé›†æˆ RAG çŸ¥è¯†åº“æ£€ç´¢ï¼Œæ”¯æŒæµå¼å“åº”ä¸è‡ªåŠ¨ç†”æ–­é™çº§ã€‚
```

### ğŸ“‹ å®Œæ•´ç‰ˆï¼ˆ5 æ¡ï¼Œé€‚åˆé¡¹ç›®è¯¦æƒ…ï¼‰

| # | äº®ç‚¹ | å…³é”®æŠ€æœ¯ | é‡åŒ–æŒ‡æ ‡ |
|---|------|---------|---------|
| 1 | **å¾®æœåŠ¡æ¶æ„è®¾è®¡** | Spring Cloud Alibaba + Nacos + Sentinel + OpenFeign | 6 ä¸ªå¾®æœåŠ¡ã€ç‹¬ç«‹éƒ¨ç½²ã€æœåŠ¡å‘ç° < 1s |
| 2 | **å¤šçº§ç¼“å­˜ç­–ç•¥** | Redis ZSet/Hash + Caffeine æœ¬åœ°ç¼“å­˜ + Cache-Aside Pattern | ç¼“å­˜å‘½ä¸­ç‡ 95%+ã€çƒ­ç‚¹æ•°æ® RT < 1ms |
| 3 | **å®æ—¶é€šè®¯ç³»ç»Ÿ** | WebSocket + RocketMQ å¼‚æ­¥æŒä¹…åŒ– + åœ¨çº¿çŠ¶æ€å¹¿æ’­ | æ”¯æ’‘ 10K+ å¹¶å‘è¿æ¥ã€æ¶ˆæ¯å»¶è¿Ÿ < 50ms |
| 4 | **AI æ™ºèƒ½æœåŠ¡** | LangChain4j + å¤šæä¾›å•†è·¯ç”± + RAG å‘é‡æ£€ç´¢ + æµå¼å“åº” | æ•…éšœè‡ªåŠ¨åˆ‡æ¢ < 3sã€æµå¼é¦–å­—èŠ‚ < 500ms |
| 5 | **æ··åˆæœç´¢å¼•æ“** | ES 7.6 + IK åˆ†è¯ + dense_vector + script_score | æœç´¢ RT < 100msã€å¬å›ç‡ 90%+ |

---

## äºŒã€ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 2.1 æ•´ä½“æ¶æ„å›¾

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                        ç”¨æˆ·ç«¯                               â”‚
                                    â”‚           Web (Vue3)  /  Mobile (H5)  /  å°ç¨‹åº             â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â”‚ HTTPS / WSS
                                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                           ç½‘å…³å±‚ (Gateway Layer)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                              Spring Cloud Gateway (Port: 8080)                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ è·¯ç”±è½¬å‘    â”‚  â”‚ Sa-Token    â”‚  â”‚  Sentinel   â”‚  â”‚ è¯·æ±‚æ—¥å¿—    â”‚  â”‚      è´Ÿè½½å‡è¡¡ (lb://)       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ PathåŒ¹é…    â”‚  â”‚ è®¤è¯é‰´æƒ    â”‚  â”‚  é™æµç†”æ–­   â”‚  â”‚ TraceId     â”‚  â”‚      Ribbon/LoadBalancer    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                                   â”‚                                   â”‚
                          â–¼                                   â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è®¤è¯æœåŠ¡ (jelly-auth)        â”‚   â”‚       ç”µå½±æœåŠ¡ (jelly-film)         â”‚   â”‚      ç¤¾åŒºæœåŠ¡ (jelly-community)     â”‚
â”‚           Port: 9100                â”‚   â”‚           Port: 9200                â”‚   â”‚           Port: 9300                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·æ³¨å†Œ/ç™»å½•               â”‚  â”‚   â”‚  â”‚ â€¢ ç”µå½±åˆ—è¡¨/è¯¦æƒ…/æœç´¢          â”‚  â”‚   â”‚  â”‚ â€¢ å¸–å­ CRUD                   â”‚  â”‚
â”‚  â”‚ â€¢ Token ç­¾å‘/éªŒè¯             â”‚  â”‚   â”‚  â”‚ â€¢ çƒ­é—¨æ¦œå• (Redis ZSet)       â”‚  â”‚   â”‚  â”‚ â€¢ è¯„è®ºæ ‘ (parent_id)          â”‚  â”‚
â”‚  â”‚ â€¢ å¯†ç åŠ å¯† (BCrypt)           â”‚  â”‚   â”‚  â”‚ â€¢ åˆ†ç±»ç¼“å­˜ (Caffeine)         â”‚  â”‚   â”‚  â”‚ â€¢ æŠ•ç¥¨ç³»ç»Ÿ (Redis Set)        â”‚  â”‚
â”‚  â”‚ â€¢ Session ç®¡ç†                â”‚  â”‚   â”‚  â”‚ â€¢ ES å…¨æ–‡æ£€ç´¢                 â”‚  â”‚   â”‚  â”‚ â€¢ çƒ­é—¨è¯é¢˜                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                                   â”‚                                   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                                   â”‚                                   â”‚
                          â–¼                                   â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        IM æœåŠ¡ (jelly-im)           â”‚   â”‚        AI æœåŠ¡ (jelly-ai)           â”‚   â”‚      ç®¡ç†æœåŠ¡ (jelly-admin)         â”‚
â”‚           Port: 9400                â”‚   â”‚           Port: 9500                â”‚   â”‚           Port: 9600                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ WebSocket é•¿è¿æ¥            â”‚  â”‚   â”‚  â”‚ â€¢ å¤šæä¾›å•†è·¯ç”±                â”‚  â”‚   â”‚  â”‚ â€¢ ç”¨æˆ·ç®¡ç†                    â”‚  â”‚
â”‚  â”‚ â€¢ ç§èŠ/ç¾¤èŠæ¶ˆæ¯               â”‚  â”‚   â”‚  â”‚ â€¢ RAG çŸ¥è¯†åº“æ£€ç´¢              â”‚  â”‚   â”‚  â”‚ â€¢ ç”µå½±ç®¡ç†                    â”‚  â”‚
â”‚  â”‚ â€¢ åœ¨çº¿çŠ¶æ€å¹¿æ’­                â”‚  â”‚   â”‚  â”‚ â€¢ æµå¼å“åº” (SSE/Flux)         â”‚  â”‚   â”‚  â”‚ â€¢ å†…å®¹å®¡æ ¸                    â”‚  â”‚
â”‚  â”‚ â€¢ RocketMQ å¼‚æ­¥æŒä¹…åŒ–         â”‚  â”‚   â”‚  â”‚ â€¢ æ•…éšœè½¬ç§»ç†”æ–­                â”‚  â”‚   â”‚  â”‚ â€¢ æ•°æ®ç»Ÿè®¡                    â”‚  â”‚
â”‚  â”‚ â€¢ å¥½å‹/ç¾¤ç»„ç®¡ç†               â”‚  â”‚   â”‚  â”‚ â€¢ AI å°è¯´ç”Ÿæˆ                 â”‚  â”‚   â”‚  â”‚ â€¢ ç³»ç»Ÿé…ç½®                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                           ä¸­é—´ä»¶å±‚ (Middleware Layer)                                         â”‚
â”‚                                                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚     Nacos     â”‚   â”‚     Redis     â”‚   â”‚   RocketMQ    â”‚   â”‚Elasticsearch  â”‚   â”‚     MinIO     â”‚          â”‚
â”‚   â”‚   æ³¨å†Œä¸­å¿ƒ    â”‚   â”‚   åˆ†å¸ƒå¼ç¼“å­˜  â”‚   â”‚   æ¶ˆæ¯é˜Ÿåˆ—    â”‚   â”‚   æœç´¢å¼•æ“    â”‚   â”‚   å¯¹è±¡å­˜å‚¨    â”‚          â”‚
â”‚   â”‚   é…ç½®ä¸­å¿ƒ    â”‚   â”‚   ä¼šè¯å­˜å‚¨    â”‚   â”‚   å¼‚æ­¥è§£è€¦    â”‚   â”‚   å‘é‡æ£€ç´¢    â”‚   â”‚   å›¾ç‰‡/æ–‡ä»¶   â”‚          â”‚
â”‚   â”‚   Port:8848   â”‚   â”‚   Port:6379   â”‚   â”‚   Port:9876   â”‚   â”‚   Port:9200   â”‚   â”‚   Port:9000   â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                           æ•°æ®å±‚ (Data Layer)                                                 â”‚
â”‚                                                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                    MySQL 8.0 (Port: 3306)                                            â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚    â”‚
â”‚   â”‚  â”‚  user è¡¨    â”‚  â”‚  film è¡¨    â”‚  â”‚  post è¡¨    â”‚  â”‚ message è¡¨  â”‚  â”‚ å…¶ä»–ä¸šåŠ¡è¡¨  â”‚                â”‚    â”‚
â”‚   â”‚  â”‚  ç”¨æˆ·ä¿¡æ¯   â”‚  â”‚  ç”µå½±æ•°æ®   â”‚  â”‚  å¸–å­å†…å®¹   â”‚  â”‚  èŠå¤©è®°å½•   â”‚  â”‚  ...        â”‚                â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯·æ±‚é“¾è·¯æµç¨‹

```
ç”¨æˆ·è¯·æ±‚å…¨é“¾è·¯è¿½è¸ªï¼š

[1] ç”¨æˆ·å‘èµ·è¯·æ±‚
     â”‚
     â–¼
[2] Gateway ç½‘å…³
     â”œâ”€â”€ è·¯ç”±åŒ¹é… (Path Predicate)
     â”œâ”€â”€ Sa-Token è®¤è¯ (ç™½åå•æ”¾è¡Œ / Tokenæ ¡éªŒ)
     â”œâ”€â”€ Sentinel é™æµæ£€æŸ¥ (QPS / çƒ­ç‚¹å‚æ•°)
     â”œâ”€â”€ æ³¨å…¥è¯·æ±‚å¤´ (X-User-Id, X-Username, X-Trace-Id)
     â”‚
     â–¼
[3] è´Ÿè½½å‡è¡¡
     â”œâ”€â”€ ä» Nacos è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
     â”œâ”€â”€ Ribbon è½®è¯¢/åŠ æƒé€‰æ‹©å®ä¾‹
     â”‚
     â–¼
[4] ä¸šåŠ¡æœåŠ¡å¤„ç†
     â”œâ”€â”€ æ‹¦æˆªå™¨æå–ç”¨æˆ·ä¸Šä¸‹æ–‡
     â”œâ”€â”€ å¤šçº§ç¼“å­˜æŸ¥è¯¢ (Caffeine â†’ Redis â†’ MySQL)
     â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘å¤„ç†
     â”œâ”€â”€ å¼‚æ­¥æ¶ˆæ¯å‘é€ (RocketMQ)
     â”‚
     â–¼
[5] å“åº”è¿”å›
     â”œâ”€â”€ ç»Ÿä¸€å“åº”æ ¼å¼ R<T>
     â”œâ”€â”€ å…¨å±€å¼‚å¸¸å¤„ç†
     â””â”€â”€ å“åº”æ—¥å¿—è®°å½•
```

### 2.3 æ•°æ®æµè½¬æ¶æ„

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚              å†™å…¥æµç¨‹                    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                             â”‚                                             â”‚
        â–¼                                             â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åŒæ­¥å†™å…¥        â”‚                     â”‚    å¼‚æ­¥å†™å…¥        â”‚                     â”‚    å»¶è¿Ÿå†™å…¥        â”‚
â”‚  (å¼ºä¸€è‡´æ€§åœºæ™¯)    â”‚                     â”‚  (é«˜å¹¶å‘åœºæ™¯)      â”‚                     â”‚  (æ‰¹é‡åœºæ™¯)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç”¨æˆ·æ³¨å†Œ         â”‚                     â”‚ â€¢ IM æ¶ˆæ¯æŒä¹…åŒ–    â”‚                     â”‚ â€¢ æ’­æ”¾é‡ç»Ÿè®¡       â”‚
â”‚ â€¢ è®¢å•åˆ›å»º         â”‚                     â”‚ â€¢ æ—¥å¿—è®°å½•         â”‚                     â”‚ â€¢ çƒ­åº¦æ¦œå•æ›´æ–°     â”‚
â”‚ â€¢ å…³é”®é…ç½®å˜æ›´     â”‚                     â”‚ â€¢ é€šçŸ¥æ¨é€         â”‚                     â”‚ â€¢ ES ç´¢å¼•åŒæ­¥      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµç¨‹ï¼š             â”‚                     â”‚ æµç¨‹ï¼š             â”‚                     â”‚ æµç¨‹ï¼š             â”‚
â”‚ Request           â”‚                     â”‚ Request           â”‚                     â”‚ Request           â”‚
â”‚   â†’ MySQL         â”‚                     â”‚   â†’ RocketMQ      â”‚                     â”‚   â†’ Redis incr    â”‚
â”‚   â†’ åˆ é™¤ç¼“å­˜      â”‚                     â”‚   â†’ Consumer      â”‚                     â”‚   â†’ å®šæ—¶ä»»åŠ¡       â”‚
â”‚   â†’ Response      â”‚                     â”‚   â†’ MySQL         â”‚                     â”‚   â†’ MySQL batch   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚              è¯»å–æµç¨‹                    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                  å¤šçº§ç¼“å­˜ç­–ç•¥                    â”‚
                              â”‚                                                 â”‚
                              â”‚    L1 Cache          L2 Cache          L3 DB   â”‚
                              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                              â”‚   â”‚Caffeine â”‚ â”€â”€â”€â–¶ â”‚  Redis  â”‚ â”€â”€â”€â–¶ â”‚ MySQL  â”‚ â”‚
                              â”‚   â”‚ (æœ¬åœ°)  â”‚      â”‚ (åˆ†å¸ƒå¼)â”‚      â”‚        â”‚ â”‚
                              â”‚   â”‚ < 1ms   â”‚      â”‚ < 5ms   â”‚      â”‚ 10-50msâ”‚ â”‚
                              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                              â”‚                                                 â”‚
                              â”‚   å‘½ä¸­ç‡: 60%       å‘½ä¸­ç‡: 35%      å‘½ä¸­ç‡: 5% â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€åŠŸèƒ½äº®ç‚¹è¯¦è§£ï¼ˆREADMEç‰ˆï¼‰

### ğŸ¬ 3.1 å½±è§†ä¸­å¿ƒ

#### åŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | æ ¸å¿ƒèƒ½åŠ› | æŠ€æœ¯å®ç° |
|---------|---------|---------|
| ç”µå½±æµè§ˆ | åˆ—è¡¨åˆ†é¡µã€åˆ†ç±»ç­›é€‰ã€æ’åº | MyBatis Plus åŠ¨æ€æŸ¥è¯¢ |
| æ™ºèƒ½æœç´¢ | å…³é”®è¯æœç´¢ã€è¯­ä¹‰æœç´¢ | ES BM25 + å‘é‡æ£€ç´¢ |
| çƒ­é—¨æ¦œå• | å®æ—¶çƒ­åº¦æ’å | Redis ZSet åŸå­æ“ä½œ |
| æ’­æ”¾ç»Ÿè®¡ | æ’­æ”¾é‡ç»Ÿè®¡ã€å†å²è®°å½• | Redis è®¡æ•° + å¼‚æ­¥è½åº“ |
| æ”¶è—è¿½å‰§ | ç”¨æˆ·æ”¶è—ã€è¿½å‰§æé†’ | MySQL + Redis ç¼“å­˜ |

#### æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”µå½±æœåŠ¡æ¶æ„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚   FilmController â”‚    â”‚  FilmService    â”‚    â”‚  FilmMapper     â”‚             â”‚
â”‚   â”‚   (REST API)     â”‚â”€â”€â”€â–¶â”‚  (ä¸šåŠ¡é€»è¾‘)     â”‚â”€â”€â”€â–¶â”‚  (æ•°æ®è®¿é—®)     â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚            â”‚                      â”‚                      â”‚                       â”‚
â”‚            â”‚                      â–¼                      â”‚                       â”‚
â”‚            â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                       â”‚
â”‚            â”‚         â”‚      ç¼“å­˜å±‚              â”‚         â”‚                       â”‚
â”‚            â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚                       â”‚
â”‚            â”‚         â”‚  â”‚Caffeine â”‚ â”‚ Redis  â”‚ â”‚         â”‚                       â”‚
â”‚            â”‚         â”‚  â”‚åˆ†ç±»ç¼“å­˜ â”‚ â”‚çƒ­é—¨æ¦œå•â”‚ â”‚         â”‚                       â”‚
â”‚            â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚                       â”‚
â”‚            â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                       â”‚
â”‚            â”‚                                             â”‚                       â”‚
â”‚            â–¼                                             â–¼                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ElasticSearch    â”‚                           â”‚     MySQL       â”‚             â”‚
â”‚   â”‚ Service         â”‚                           â”‚    æ•°æ®åº“       â”‚             â”‚
â”‚   â”‚ â€¢ å…³é”®è¯æœç´¢    â”‚                           â”‚    film è¡¨      â”‚             â”‚
â”‚   â”‚ â€¢ å‘é‡æ£€ç´¢      â”‚                           â”‚    category è¡¨  â”‚             â”‚
â”‚   â”‚ â€¢ æ··åˆæœç´¢      â”‚                           â”‚    favorite è¡¨  â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç å®ç°

**1. çƒ­é—¨æ¦œå•ç³»ç»Ÿï¼ˆRedis ZSet å®ç°ï¼‰**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: FilmServiceImpl.java

// ==================== Key è®¾è®¡ ====================
private static final String FILM_HOT_RANK_KEY = "jelly:film:hot:rank";      // çƒ­é—¨æ¦œå• ZSet
private static final String FILM_PLAY_COUNT_KEY = "jelly:film:play:count:"; // æ’­æ”¾é‡è®¡æ•°

// ==================== æ’­æ”¾é‡è‡ªå¢ï¼ˆå†™å…¥ï¼‰ ====================
@Override
public void incrementPlayCount(Long id) {
    // 1. Redis è®¡æ•°å™¨è‡ªå¢ï¼ˆåŸå­æ“ä½œï¼Œé«˜å¹¶å‘å®‰å…¨ï¼‰
    String key = FILM_PLAY_COUNT_KEY + id;
    redisService.increment(key);
    
    // 2. æ›´æ–°çƒ­é—¨æ¦œå•åˆ†æ•°ï¼ˆZSet score +1ï¼‰
    redisService.zIncrementScore(FILM_HOT_RANK_KEY, id, 1);
    
    log.debug("ç”µå½±æ’­æ”¾é‡ +1, id={}", id);
}

// ==================== çƒ­é—¨æ¦œå•æŸ¥è¯¢ï¼ˆè¯»å–ï¼‰ ====================
@Override
public List<FilmVO> getHotRank(Integer size) {
    int limit = size != null ? size : 10;
    
    try {
        // ä¼˜å…ˆä» Redis ZSet è·å–ï¼ˆæŒ‰åˆ†æ•°é™åºï¼‰
        Set<Object> cachedIds = redisService.zReverseRange(FILM_HOT_RANK_KEY, 0, limit - 1);
        
        if (cachedIds != null && !cachedIds.isEmpty()) {
            return cachedIds.stream()
                    .map(obj -> getDetail(Long.valueOf(obj.toString())))
                    .filter(Objects::nonNull)
                    .collect(Collectors.toList());
        }
    } catch (Exception e) {
        log.warn("ä» Redis è·å–çƒ­é—¨æ¦œå•å¤±è´¥ï¼Œfallback åˆ°æ•°æ®åº“æŸ¥è¯¢", e);
    }
    
    // Redis å¼‚å¸¸æ—¶é™çº§åˆ° MySQL
    return filmMapper.selectList(new LambdaQueryWrapper<Film>()
            .eq(Film::getStatus, 0)
            .orderByDesc(Film::getPlayCount)
            .last("LIMIT " + limit))
            .stream().map(this::toVO).collect(Collectors.toList());
}
```

**è®¾è®¡è¦ç‚¹è¯´æ˜ï¼š**
| è®¾è®¡ç‚¹ | æ–¹æ¡ˆ | åŸå›  |
|-------|------|------|
| æ•°æ®ç»“æ„ | Redis ZSet | O(logN) æ’å…¥ã€O(1) Top N æŸ¥è¯¢ |
| åŸå­æ€§ | ZINCRBY å‘½ä»¤ | é«˜å¹¶å‘ä¸‹è®¡æ•°å‡†ç¡® |
| é™çº§ç­–ç•¥ | MySQL fallback | Redis æ•…éšœæ—¶æœåŠ¡å¯ç”¨ |
| æ•°æ®åŒæ­¥ | å®šæ—¶ä»»åŠ¡ | é¿å… Redis æ•°æ®ä¸¢å¤± |

---

**2. å¤šçº§ç¼“å­˜æ¶æ„ï¼ˆCaffeine + Redisï¼‰**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: FilmServiceImpl.java

// ==================== L1 æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰ ====================
private final Cache<Long, Category> categoryCache = Caffeine.newBuilder()
        .maximumSize(100)                        // æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
        .expireAfterWrite(10, TimeUnit.MINUTES)  // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ
        .recordStats()                            // å¼€å¯ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰
        .build();

// ==================== ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹ ====================
private FilmVO toVO(Film film) {
    FilmVO vo = BeanUtil.copyProperties(film, FilmVO.class);
    
    // ä»æœ¬åœ°ç¼“å­˜è·å–åˆ†ç±»ä¿¡æ¯ï¼ˆç¼“å­˜ç©¿é€ï¼šè‡ªåŠ¨åŠ è½½ï¼‰
    if (film.getCategoryId() != null) {
        Category category = categoryCache.get(film.getCategoryId(), 
                id -> categoryMapper.selectById(id));  // ç¼“å­˜æœªå‘½ä¸­æ—¶çš„åŠ è½½å‡½æ•°
        if (category != null) {
            vo.setCategoryName(category.getName());
        }
    }
    return vo;
}
```

**å¤šçº§ç¼“å­˜è¯»å–æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¤šçº§ç¼“å­˜æŸ¥è¯¢æµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   è¯·æ±‚ â”€â”€â–¶ Caffeine (L1)                                                       â”‚
â”‚                â”‚                                                                â”‚
â”‚                â”œâ”€â”€ å‘½ä¸­ â”€â”€â–¶ ç›´æ¥è¿”å› (RT < 1ms)                                 â”‚
â”‚                â”‚                                                                â”‚
â”‚                â””â”€â”€ æœªå‘½ä¸­ â”€â”€â–¶ Redis (L2)                                        â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â”œâ”€â”€ å‘½ä¸­ â”€â”€â–¶ å†™å…¥ L1 â”€â”€â–¶ è¿”å› (RT < 5ms)    â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â””â”€â”€ æœªå‘½ä¸­ â”€â”€â–¶ MySQL (L3)                    â”‚
â”‚                                                       â”‚                         â”‚
â”‚                                                       â””â”€â”€ å†™å…¥ L2 â”€â”€â–¶ å†™å…¥ L1   â”‚
â”‚                                                                   â”‚             â”‚
â”‚                                                                   â–¼             â”‚
â”‚                                                              è¿”å› (RT < 50ms)   â”‚
â”‚                                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼“å­˜é—®é¢˜é˜²æŠ¤ï¼š                                                                  â”‚
â”‚  â€¢ ç©¿é€ï¼šç¼“å­˜ç©ºå€¼ï¼ˆTTL=5minï¼‰ + å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆå¯é€‰ï¼‰                               â”‚
â”‚  â€¢ å‡»ç©¿ï¼šCaffeine å†…ç½®å•æœºé” + Redisson åˆ†å¸ƒå¼é”                                â”‚
â”‚  â€¢ é›ªå´©ï¼šTTL éšæœºåŒ–ï¼ˆåŸºç¡€å€¼ Â± 20%ï¼‰ + ç†”æ–­é™çº§                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**3. Elasticsearch æ··åˆæœç´¢**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: ElasticSearchService.java

// ==================== å…³é”®è¯æœç´¢ï¼ˆBM25 ç®—æ³•ï¼‰ ====================
public List<Long> searchByKeyword(String keyword, int size) {
    SearchRequest searchRequest = new SearchRequest(FILM_INDEX);
    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
    
    // å¤šå­—æ®µåŠ æƒæœç´¢
    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery()
            .should(QueryBuilders.matchQuery("title", keyword).boost(3.0f))       // æ ‡é¢˜æƒé‡ 3x
            .should(QueryBuilders.matchQuery("actors", keyword).boost(2.0f))      // æ¼”å‘˜æƒé‡ 2x
            .should(QueryBuilders.matchQuery("director", keyword).boost(2.0f))    // å¯¼æ¼”æƒé‡ 2x
            .should(QueryBuilders.matchQuery("description", keyword).boost(1.0f)); // æè¿°æƒé‡ 1x
    
    sourceBuilder.query(boolQuery);
    sourceBuilder.size(size);
    // ...
}

// ==================== å‘é‡è¯­ä¹‰æ£€ç´¢ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ ====================
public List<Long> searchByVector(float[] queryVector, int size) {
    // ES 7.6 æ–¹æ¡ˆï¼šscript_score + cosineSimilarity
    Map<String, Object> params = new HashMap<>();
    params.put("query_vector", queryVector);
    
    Script script = new Script(
            ScriptType.INLINE,
            "painless",
            "cosineSimilarity(params.query_vector, 'embedding') + 1.0",  // +1 é¿å…è´Ÿåˆ†
            params
    );
    
    sourceBuilder.query(QueryBuilders.scriptScoreQuery(
            QueryBuilders.matchAllQuery(),
            script
    ));
    // ...
}

// ==================== æ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯ + å‘é‡é‡æ’åºï¼‰ ====================
public List<Long> hybridSearch(String keyword, float[] queryVector, int size) {
    // Step 1: å…³é”®è¯å¬å›ï¼ˆç²—æ’ï¼‰
    List<Long> keywordResults = searchByKeyword(keyword, size * 2);  // å¬å› 2 å€
    
    // Step 2: å‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰å¬å›ï¼‰
    List<Long> vectorResults = searchByVector(queryVector, size);
    
    // Step 3: ç»“æœèåˆï¼ˆå»é‡ + æ’åºï¼‰
    List<Long> merged = new ArrayList<>(keywordResults);
    for (Long id : vectorResults) {
        if (!merged.contains(id)) {
            merged.add(id);
        }
    }
    
    return merged.stream().limit(size).toList();
}
```

**ES ç´¢å¼• Mapping è®¾è®¡ï¼š**

```json
{
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",        // ç´¢å¼•æ—¶ï¼šç»†ç²’åº¦åˆ†è¯ï¼ˆæé«˜å¬å›ï¼‰
        "search_analyzer": "ik_smart"      // æœç´¢æ—¶ï¼šæ™ºèƒ½åˆ†è¯ï¼ˆæé«˜ç²¾åº¦ï¼‰
      },
      "description": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "actors": { "type": "text", "analyzer": "ik_max_word" },
      "director": { "type": "text", "analyzer": "ik_max_word" },
      "tags": { "type": "keyword" },
      "rating": { "type": "float" },
      "playCount": { "type": "long" },
      "year": { "type": "integer" },
      "embedding": {
        "type": "dense_vector",
        "dims": 1024                        // BGE-M3 å‘é‡ç»´åº¦
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
```

---

### ğŸ’¬ 3.2 å³æ—¶é€šè®¯ç³»ç»Ÿ

#### åŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | æ ¸å¿ƒèƒ½åŠ› | æŠ€æœ¯å®ç° |
|---------|---------|---------|
| å®æ—¶æ¶ˆæ¯ | ç§èŠã€ç¾¤èŠã€ç³»ç»Ÿé€šçŸ¥ | WebSocket + æ¶ˆæ¯è·¯ç”± |
| åœ¨çº¿çŠ¶æ€ | å®æ—¶çŠ¶æ€åŒæ­¥ã€å¥½å‹ä¸Šä¸‹çº¿é€šçŸ¥ | ConcurrentHashMap + å¹¿æ’­ |
| æ¶ˆæ¯æŒä¹…åŒ– | èŠå¤©è®°å½•å­˜å‚¨ã€å†å²æ¶ˆæ¯æŸ¥è¯¢ | RocketMQ å¼‚æ­¥ + MySQL |
| æ–‡ä»¶ä¼ è¾“ | å›¾ç‰‡ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ | MinIO å¯¹è±¡å­˜å‚¨ |
| å¥½å‹ç³»ç»Ÿ | å¥½å‹ç”³è¯·ã€å¥½å‹åˆ—è¡¨ã€å¤‡æ³¨ | MySQL + Redis ç¼“å­˜ |
| ç¾¤ç»„ç®¡ç† | å»ºç¾¤ã€é‚€è¯·ã€ç¾¤å…¬å‘Š | MySQL + WebSocket ç¾¤å‘ |

#### æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               IM æœåŠ¡æ•´ä½“æ¶æ„                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                            WebSocket è¿æ¥å±‚                                      â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚   â”‚  â”‚  Client 1   â”‚    â”‚  Client 2   â”‚    â”‚  Client 3   â”‚    â”‚  Client N   â”‚       â”‚  â”‚
â”‚   â”‚  â”‚  (userId=1) â”‚    â”‚  (userId=2) â”‚    â”‚  (userId=3) â”‚    â”‚  (userId=N) â”‚       â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚   â”‚         â”‚                  â”‚                  â”‚                  â”‚              â”‚  â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚   â”‚                                       â”‚                                          â”‚  â”‚
â”‚   â”‚                                       â–¼                                          â”‚  â”‚
â”‚   â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚
â”‚   â”‚                        â”‚    WebSocket Handler        â”‚                          â”‚  â”‚
â”‚   â”‚                        â”‚  (ChatWebSocketHandler)     â”‚                          â”‚  â”‚
â”‚   â”‚                        â”‚  â€¢ è¿æ¥ç®¡ç†                 â”‚                          â”‚  â”‚
â”‚   â”‚                        â”‚  â€¢ æ¶ˆæ¯è·¯ç”±                 â”‚                          â”‚  â”‚
â”‚   â”‚                        â”‚  â€¢ åœ¨çº¿çŠ¶æ€ç»´æŠ¤             â”‚                          â”‚  â”‚
â”‚   â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚                          â”‚                          â”‚                  â”‚
â”‚              â–¼                          â–¼                          â–¼                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚    åœ¨çº¿çŠ¶æ€ç®¡ç†      â”‚   â”‚    æ¶ˆæ¯æœåŠ¡         â”‚   â”‚    å¥½å‹/ç¾¤ç»„æœåŠ¡     â”‚        â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
â”‚   â”‚  â”‚ConcurrentHash â”‚  â”‚   â”‚  â”‚MessageService â”‚  â”‚   â”‚  â”‚FriendService  â”‚  â”‚        â”‚
â”‚   â”‚  â”‚Map<userId,    â”‚  â”‚   â”‚  â”‚ â€¢ æ¶ˆæ¯å‘é€    â”‚  â”‚   â”‚  â”‚GroupService   â”‚  â”‚        â”‚
â”‚   â”‚  â”‚Session>       â”‚  â”‚   â”‚  â”‚ â€¢ æ¶ˆæ¯æ¨é€    â”‚  â”‚   â”‚  â”‚ â€¢ å¥½å‹ç®¡ç†    â”‚  â”‚        â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚ â€¢ å†å²æŸ¥è¯¢    â”‚  â”‚   â”‚  â”‚ â€¢ ç¾¤ç»„ç®¡ç†    â”‚  â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                    â”‚
â”‚              â”‚                         â”‚                         â”‚                    â”‚
â”‚              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                    â”‚
â”‚              â”‚              â”‚                     â”‚              â”‚                    â”‚
â”‚              â–¼              â–¼                     â–¼              â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚     Redis       â”‚  â”‚    RocketMQ      â”‚  â”‚       MySQL         â”‚                 â”‚
â”‚   â”‚  â€¢ åœ¨çº¿çŠ¶æ€     â”‚  â”‚  â€¢ IM_MSG_SEND   â”‚  â”‚  â€¢ chat_message     â”‚                 â”‚
â”‚   â”‚  â€¢ ä¼šè¯ç¼“å­˜     â”‚  â”‚  â€¢ å¼‚æ­¥æŒä¹…åŒ–    â”‚  â”‚  â€¢ friend           â”‚                 â”‚
â”‚   â”‚  â€¢ æœªè¯»è®¡æ•°     â”‚  â”‚  â€¢ å‰Šå³°å¡«è°·      â”‚  â”‚  â€¢ group            â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç å®ç°

**1. WebSocket è¿æ¥ç®¡ç†ï¼ˆåœ¨çº¿çŠ¶æ€ï¼‰**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: ChatWebSocketHandler.java

/**
 * WebSocket æ¶ˆæ¯å¤„ç†å™¨
 * æ ¸å¿ƒèŒè´£ï¼šè¿æ¥ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€åœ¨çº¿çŠ¶æ€ç»´æŠ¤
 */
@Slf4j
@Component
public class ChatWebSocketHandler extends TextWebSocketHandler {

    // ==================== åœ¨çº¿ç”¨æˆ·ä¼šè¯å­˜å‚¨ï¼ˆæ ¸å¿ƒï¼‰ ====================
    // Key: userId, Value: WebSocketSession
    // ä½¿ç”¨ ConcurrentHashMap ä¿è¯çº¿ç¨‹å®‰å…¨
    private static final Map<Long, WebSocketSession> ONLINE_SESSIONS = new ConcurrentHashMap<>();

    // ==================== è¿æ¥å»ºç«‹ ====================
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        Long userId = getUserId(session);
        if (userId != null) {
            // 1. æ³¨å†Œç”¨æˆ·ä¼šè¯
            ONLINE_SESSIONS.put(userId, session);
            log.info("ç”¨æˆ·ä¸Šçº¿: {}, å½“å‰åœ¨çº¿äººæ•°: {}", userId, ONLINE_SESSIONS.size());
            
            // 2. å¹¿æ’­ä¸Šçº¿é€šçŸ¥ç»™æ‰€æœ‰å¥½å‹
            notifyFriendsOnlineStatus(userId, true);
        }
    }

    // ==================== è¿æ¥æ–­å¼€ï¼ˆå…³é”®ï¼šé˜²æ­¢æ–°æ—§è¿æ¥è¦†ç›–ï¼‰ ====================
    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) {
        Long userId = getUserId(session);
        if (userId != null) {
            // å…³é”®åˆ¤æ–­ï¼šåªæœ‰å½“å‰ session æ˜¯å­˜å‚¨çš„ session æ—¶æ‰ç§»é™¤
            // åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿé‡è¿æ—¶ï¼Œæ–°è¿æ¥å…ˆå»ºç«‹ï¼Œæ—§è¿æ¥åæ–­å¼€
            WebSocketSession storedSession = ONLINE_SESSIONS.get(userId);
            if (storedSession != null && storedSession.getId().equals(session.getId())) {
                ONLINE_SESSIONS.remove(userId);
                log.info("ç”¨æˆ·ä¸‹çº¿: {}, å½“å‰åœ¨çº¿äººæ•°: {}", userId, ONLINE_SESSIONS.size());
                notifyFriendsOnlineStatus(userId, false);
            } else {
                log.info("æ—§è¿æ¥å…³é—­ï¼Œä½†ç”¨æˆ·å·²æœ‰æ–°è¿æ¥: userId={}", userId);
            }
        }
    }

    // ==================== æ¶ˆæ¯å¤„ç† ====================
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) {
        Long userId = getUserId(session);
        try {
            // è§£ææ¶ˆæ¯ DTO
            MessageDTO dto = JSONUtil.toBean(message.getPayload(), MessageDTO.class);
            // å§”æ‰˜ç»™ MessageService å¤„ç†ï¼ˆå‘é€ + æŒä¹…åŒ–ï¼‰
            messageService.sendMessage(userId, dto);
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥: userId={}", userId, e);
            sendError(session, "æ¶ˆæ¯å¤„ç†å¤±è´¥: " + e.getMessage());
        }
    }

    // ==================== æ¶ˆæ¯æ¨é€ï¼ˆå•å‘ï¼‰ ====================
    public void sendToUser(Long userId, String message) {
        WebSocketSession session = ONLINE_SESSIONS.get(userId);
        if (session != null && session.isOpen()) {
            try {
                session.sendMessage(new TextMessage(message));
            } catch (IOException e) {
                log.error("å‘é€æ¶ˆæ¯å¤±è´¥: userId={}", userId, e);
            }
        } else {
            log.warn("ç”¨æˆ·ä¸åœ¨çº¿ï¼Œæ— æ³•æ¨é€: userId={}", userId);
            // TODO: å¯ä»¥åœ¨è¿™é‡Œè§¦å‘ç¦»çº¿æ¶ˆæ¯å­˜å‚¨
        }
    }

    // ==================== æ¶ˆæ¯æ¨é€ï¼ˆç¾¤å‘ï¼‰ ====================
    public void sendToUsers(Iterable<Long> userIds, String message) {
        for (Long userId : userIds) {
            sendToUser(userId, message);
        }
    }

    // ==================== åœ¨çº¿çŠ¶æ€å¹¿æ’­ ====================
    private void notifyFriendsOnlineStatus(Long userId, boolean online) {
        List<FriendVO> friends = friendService.getFriendList(userId);
        if (friends == null || friends.isEmpty()) return;
        
        Map<String, Object> notification = Map.of(
            "type", "online",
            "userId", String.valueOf(userId),  // å­—ç¬¦ä¸²é¿å… JS å¤§æ•°å­—ç²¾åº¦ä¸¢å¤±
            "online", online
        );
        String json = JSONUtil.toJsonStr(notification);
        
        for (FriendVO friend : friends) {
            if (isOnline(friend.getId())) {
                sendToUser(friend.getId(), json);
            }
        }
    }
}
```

**è®¾è®¡è¦ç‚¹è¯´æ˜ï¼š**

| é—®é¢˜åœºæ™¯ | è§£å†³æ–¹æ¡ˆ | ä»£ç å®ç° |
|---------|---------|---------|
| çº¿ç¨‹å®‰å…¨ | ConcurrentHashMap | å¤šçº¿ç¨‹å¹¶å‘æ“ä½œå®‰å…¨ |
| è¿æ¥è¦†ç›– | SessionId æ¯”å¯¹ | æ–°è¿æ¥ä¸è¢«æ—§è¿æ¥æ–­å¼€äº‹ä»¶è¦†ç›– |
| å¤§æ•°å­—ç²¾åº¦ | String ä¼ è¾“ | userId è½¬å­—ç¬¦ä¸²é¿å… JS ç²¾åº¦ä¸¢å¤± |
| ç¦»çº¿ç”¨æˆ· | æ—¥å¿— + TODO | å¯æ‰©å±•ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ— |

---

**2. RocketMQ æ¶ˆæ¯å¼‚æ­¥æŒä¹…åŒ–**

```java
// ==================== æ¶ˆæ¯ç”Ÿäº§è€… ====================
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: MessageProducer.java

@Slf4j
@Component
@RequiredArgsConstructor
@ConditionalOnBean(RocketMQTemplate.class)  // æ¡ä»¶è£…é…ï¼šMQ å¯ç”¨æ—¶æ‰ç”Ÿæ•ˆ
public class MessageProducer {

    private final RocketMQTemplate rocketMQTemplate;
    private static final String TOPIC = "IM_MSG_SEND";

    /**
     * å‘é€æ¶ˆæ¯åˆ° MQï¼ˆå¼‚æ­¥ï¼Œéé˜»å¡ï¼‰
     */
    public void sendMessage(ChatMessage message) {
        try {
            String json = JSONUtil.toJsonStr(message);
            rocketMQTemplate.convertAndSend(TOPIC, json);
            log.debug("æ¶ˆæ¯æŠ•é€’ MQ æˆåŠŸ: msgId={}", message.getId());
        } catch (Exception e) {
            log.error("æ¶ˆæ¯æŠ•é€’ MQ å¤±è´¥ï¼Œè§¦å‘åŒæ­¥å†™å…¥å…œåº•", e);
            // TODO: åŒæ­¥å†™å…¥ MySQL ä½œä¸ºå…œåº•
        }
    }
}

// ==================== æ¶ˆæ¯æ¶ˆè´¹è€… ====================
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: MessageConsumer.java

@Slf4j
@Component
@RequiredArgsConstructor
@ConditionalOnBean(RocketMQTemplate.class)
@RocketMQMessageListener(
    topic = "IM_MSG_SEND",
    consumerGroup = "im-consumer-group",
    consumeMode = ConsumeMode.ORDERLY  // é¡ºåºæ¶ˆè´¹ï¼ˆå¯é€‰ï¼šä¿è¯æ¶ˆæ¯é¡ºåºï¼‰
)
public class MessageConsumer implements RocketMQListener<String> {

    private final ChatMessageMapper chatMessageMapper;

    @Override
    public void onMessage(String message) {
        try {
            ChatMessage chatMessage = JSONUtil.toBean(message, ChatMessage.class);
            
            // å¹‚ç­‰å¤„ç†ï¼šINSERT IGNORE æˆ–å…ˆæŸ¥è¯¢
            chatMessageMapper.insert(chatMessage);
            
            log.debug("æ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸ: msgId={}", chatMessage.getId());
        } catch (Exception e) {
            log.error("æ¶ˆæ¯æŒä¹…åŒ–å¤±è´¥: {}", message, e);
            // RocketMQ è‡ªåŠ¨é‡è¯•ï¼Œæœ€ç»ˆè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
            throw new RuntimeException(e);
        }
    }
}
```

**æ¶ˆæ¯æµè½¬æ—¶åºå›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·A   â”‚     â”‚WebSocket â”‚     â”‚ Message  â”‚     â”‚ RocketMQ â”‚     â”‚ Consumer â”‚
â”‚ (å‘é€æ–¹) â”‚     â”‚ Handler  â”‚     â”‚ Service  â”‚     â”‚          â”‚     â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 1.å‘é€æ¶ˆæ¯     â”‚                â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 2.å¤„ç†æ¶ˆæ¯     â”‚                â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 3.å®æ—¶æ¨é€ç»™æ¥æ”¶æ–¹ï¼ˆå¦‚æœåœ¨çº¿ï¼‰   â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 4.å¼‚æ­¥æŠ•é€’MQ   â”‚                â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚ 5.æ¶ˆè´¹æ¶ˆæ¯     â”‚
     â”‚                â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚    6.å†™å…¥MySQL â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚â”€â”€â–¶ DB
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 7.å‘é€æˆåŠŸå“åº” â”‚                â”‚                â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
```

---

### ğŸ“ 3.3 ç¤¾åŒºè®ºå›

#### åŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | æ ¸å¿ƒèƒ½åŠ› | æŠ€æœ¯å®ç° |
|---------|---------|---------|
| å¸–å­ç³»ç»Ÿ | å‘å¸ƒã€ç¼–è¾‘ã€åˆ é™¤ã€Markdown | MySQL + ES ç´¢å¼• |
| æŠ•ç¥¨ç³»ç»Ÿ | èµåŒ/åå¯¹ï¼ˆä»¿çŸ¥ä¹ï¼‰ | Redis Set + å®šæ—¶åŒæ­¥ |
| è¯„è®ºç³»ç»Ÿ | å¤šçº§è¯„è®ºã€ç‚¹èµã€å›å¤ | parent_id æ ‘ç»“æ„ |
| æ ‡ç­¾ç³»ç»Ÿ | æ ‡ç­¾åˆ†ç±»ã€çƒ­é—¨è¯é¢˜ | MySQL + Redis çƒ­åº¦ |

#### æŠ•ç¥¨ç³»ç»Ÿè®¾è®¡ï¼ˆä»¿çŸ¥ä¹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æŠ•ç¥¨ç³»ç»Ÿæ¶æ„                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   ç”¨æˆ·æŠ•ç¥¨è¯·æ±‚                                                                   â”‚
â”‚        â”‚                                                                        â”‚
â”‚        â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                        Redis å­˜å‚¨å±‚                                  â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â”‚   Key: post:vote:{postId}:up      â†’  Set<userId>   // èµåŒç”¨æˆ·é›†åˆ  â”‚      â”‚
â”‚   â”‚   Key: post:vote:{postId}:down    â†’  Set<userId>   // åå¯¹ç”¨æˆ·é›†åˆ  â”‚      â”‚
â”‚   â”‚   Key: post:score:{postId}        â†’  String        // çƒ­åº¦åˆ†æ•°      â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â”‚   æ“ä½œï¼š                                                             â”‚      â”‚
â”‚   â”‚   â€¢ SADD   æ·»åŠ æŠ•ç¥¨                                                  â”‚      â”‚
â”‚   â”‚   â€¢ SREM   å–æ¶ˆæŠ•ç¥¨                                                  â”‚      â”‚
â”‚   â”‚   â€¢ SISMEMBER æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨                                         â”‚      â”‚
â”‚   â”‚   â€¢ SMOVE  åˆ‡æ¢æŠ•ç¥¨ï¼ˆèµåŒâ†”åå¯¹ï¼‰                                     â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â”‚ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰                       â”‚
â”‚                                    â–¼                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                        MySQL æŒä¹…åŒ–å±‚                                â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â”‚   post è¡¨:  up_count, down_count, score                             â”‚      â”‚
â”‚   â”‚   post_vote è¡¨:  user_id, post_id, vote_type, create_time           â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ•ç¥¨æ“ä½œæµç¨‹ï¼š**

```java
// æŠ•ç¥¨æœåŠ¡ä¼ªä»£ç 
public void vote(Long userId, Long postId, VoteType type) {
    String upKey = "post:vote:" + postId + ":up";
    String downKey = "post:vote:" + postId + ":down";
    
    // 1. æ£€æŸ¥å½“å‰æŠ•ç¥¨çŠ¶æ€
    boolean hasVotedUp = redisService.sIsMember(upKey, userId);
    boolean hasVotedDown = redisService.sIsMember(downKey, userId);
    
    // 2. å¤„ç†æŠ•ç¥¨é€»è¾‘
    if (type == VoteType.UP) {
        if (hasVotedUp) {
            // å–æ¶ˆèµåŒ
            redisService.sRemove(upKey, userId);
        } else {
            // æ·»åŠ èµåŒï¼ˆå¦‚æœä¹‹å‰åå¯¹ï¼Œå…ˆç§»é™¤ï¼‰
            if (hasVotedDown) {
                redisService.sRemove(downKey, userId);
            }
            redisService.sAdd(upKey, userId);
        }
    } else if (type == VoteType.DOWN) {
        // ç±»ä¼¼é€»è¾‘...
    }
    
    // 3. æ›´æ–°çƒ­åº¦åˆ†æ•°ï¼ˆèµåŒ +1ï¼Œåå¯¹ -1ï¼‰
    updatePostScore(postId);
}
```

---

### ğŸ¤– 3.4 AI æ™ºèƒ½åŠ©æ‰‹

#### åŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | æ ¸å¿ƒèƒ½åŠ› | æŠ€æœ¯å®ç° |
|---------|---------|---------|
| æ™ºèƒ½å¯¹è¯ | å¤šè½®å¯¹è¯ã€ä¸Šä¸‹æ–‡è®°å¿† | LangChain4j ChatMemory |
| æµå¼å“åº” | SSE é€å­—è¾“å‡º | Reactor Flux + Sinks |
| RAG æ£€ç´¢ | çŸ¥è¯†åº“é—®ç­” | ES å‘é‡æ£€ç´¢ + Prompt æ³¨å…¥ |
| æ•…éšœè½¬ç§» | å¤šæä¾›å•†åˆ‡æ¢ | ä¼˜å…ˆçº§ + ç†”æ–­å™¨ |
| å°è¯´ç”Ÿæˆ | å¤§çº²ç”Ÿæˆã€ç« èŠ‚ç»­å†™ | Prompt Engineering |

#### æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               AI æœåŠ¡æ•´ä½“æ¶æ„                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                          API å±‚ (ChatController)                              â”‚    â”‚
â”‚   â”‚  POST /ai/chat           â†’  åŒæ­¥å¯¹è¯                                          â”‚    â”‚
â”‚   â”‚  POST /ai/chat/stream    â†’  æµå¼å¯¹è¯ (SSE)                                    â”‚    â”‚
â”‚   â”‚  POST /ai/rag/search     â†’  RAG æ£€ç´¢é—®ç­”                                      â”‚    â”‚
â”‚   â”‚  POST /ai/novel/generate â†’  å°è¯´ç”Ÿæˆ                                          â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                       æœåŠ¡å±‚ (ChatService / RagService)                       â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚   â”‚  â”‚                    å¤šæä¾›å•†è·¯ç”± (MultiProviderAiConfig)                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                                                                          â”‚ â”‚    â”‚
â”‚   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚   â”‚  DeepSeek   â”‚   â”‚ SiliconFlow â”‚   â”‚   OpenAI    â”‚                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚   â”‚ priority=1  â”‚   â”‚ priority=2  â”‚   â”‚ priority=3  â”‚                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚   â”‚   (ä¸»ç”¨)    â”‚   â”‚   (å¤‡ç”¨)    â”‚   â”‚   (å¤‡ç”¨)    â”‚                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚          â”‚                  â”‚                  â”‚                        â”‚ â”‚    â”‚
â”‚   â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                             â”‚                                            â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                    â”‚   å¥åº·æ£€æŸ¥å™¨     â”‚                                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                    â”‚ â€¢ å¤±è´¥è®¡æ•°       â”‚                                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                    â”‚ â€¢ ç†”æ–­çŠ¶æ€       â”‚                                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                    â”‚ â€¢ è‡ªåŠ¨æ¢å¤       â”‚                                   â”‚ â”‚    â”‚
â”‚   â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚ â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚                                                      â”‚                  â”‚
â”‚              â–¼                                                      â–¼                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚   LangChain4j æ¨¡å‹   â”‚                            â”‚   RAG æ£€ç´¢é“¾è·¯       â”‚        â”‚
â”‚   â”‚  â€¢ ChatLanguageModel â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
â”‚   â”‚  â€¢ StreamingModel    â”‚                            â”‚  â”‚ 1.æ–‡æ¡£åˆ†ç‰‡     â”‚  â”‚        â”‚
â”‚   â”‚  â€¢ EmbeddingModel    â”‚                            â”‚  â”‚ 2.å‘é‡åŒ–(BGE)  â”‚  â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚ 3.ES å­˜å‚¨      â”‚  â”‚        â”‚
â”‚                                                        â”‚  â”‚ 4.ç›¸ä¼¼åº¦æ£€ç´¢   â”‚  â”‚        â”‚
â”‚                                                        â”‚  â”‚ 5.Promptæ³¨å…¥   â”‚  â”‚        â”‚
â”‚                                                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚
â”‚                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç å®ç°

**1. å¤šæä¾›å•†æ•…éšœè½¬ç§»æœºåˆ¶**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: MultiProviderAiConfig.java

@Slf4j
@Configuration
@RequiredArgsConstructor
public class MultiProviderAiConfig {

    private final AiProviderProperties properties;
    
    // ==================== æä¾›å•†å¥åº·çŠ¶æ€å­˜å‚¨ ====================
    private final ConcurrentHashMap<String, ProviderHealth> healthStatus = new ConcurrentHashMap<>();

    // ==================== è·å–å½“å‰å¯ç”¨æä¾›å•†ï¼ˆæ ¸å¿ƒï¼‰ ====================
    private AiProviderProperties.Provider getActiveProvider() {
        List<AiProviderProperties.Provider> providers = properties.getProviders().stream()
                .filter(AiProviderProperties.Provider::isEnabled)   // 1. è¿‡æ»¤å¯ç”¨çš„
                .filter(p -> isHealthy(p.getName()))                 // 2. è¿‡æ»¤å¥åº·çš„
                .sorted(Comparator.comparingInt(AiProviderProperties.Provider::getPriority))  // 3. æŒ‰ä¼˜å…ˆçº§æ’åº
                .toList();

        if (providers.isEmpty()) {
            // å…œåº•ï¼šæ‰€æœ‰æä¾›å•†ä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ï¼ˆå°è¯•æ¢å¤ï¼‰
            log.warn("æ‰€æœ‰ AI æä¾›å•†ä¸å¥åº·ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„æä¾›å•†");
            return properties.getProviders().stream()
                    .filter(AiProviderProperties.Provider::isEnabled)
                    .findFirst()
                    .orElseThrow(() -> new IllegalStateException("æ²¡æœ‰å¯ç”¨çš„ AI æä¾›å•†"));
        }

        return providers.get(0);
    }

    // ==================== å¥åº·æ£€æŸ¥ï¼ˆç†”æ–­å™¨é€»è¾‘ï¼‰ ====================
    private boolean isHealthy(String providerName) {
        ProviderHealth health = healthStatus.get(providerName);
        if (health == null) {
            return true;  // æ–°æä¾›å•†é»˜è®¤å¥åº·
        }
        
        // ç†”æ–­åˆ¤æ–­ï¼šå¤±è´¥æ¬¡æ•° >= é˜ˆå€¼
        if (health.failureCount.get() >= properties.getFailover().getFailureThreshold()) {
            long elapsed = System.currentTimeMillis() - health.lastFailureTime;
            
            // ç†”æ–­è¶…æ—¶åå°è¯•æ¢å¤ï¼ˆHalf-Open çŠ¶æ€ï¼‰
            if (elapsed > properties.getFailover().getTimeout() * 1000L) {
                log.info("æä¾›å•† {} ç†”æ–­è¶…æ—¶ï¼Œå°è¯•æ¢å¤", providerName);
                health.failureCount.set(0);  // é‡ç½®è®¡æ•°
                return true;
            }
            
            return false;  // ç†”æ–­ä¸­
        }
        return true;
    }

    // ==================== è®°å½•å¤±è´¥ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰ ====================
    public void recordFailure(String providerName) {
        healthStatus.computeIfAbsent(providerName, k -> new ProviderHealth())
                .recordFailure();
        log.warn("AI æä¾›å•† {} è¯·æ±‚å¤±è´¥ï¼Œå½“å‰å¤±è´¥æ¬¡æ•°: {}", 
                providerName, healthStatus.get(providerName).failureCount.get());
    }

    // ==================== è®°å½•æˆåŠŸï¼ˆé‡ç½®è®¡æ•°ï¼‰ ====================
    public void recordSuccess(String providerName) {
        ProviderHealth health = healthStatus.get(providerName);
        if (health != null) {
            health.failureCount.set(0);
        }
    }

    // ==================== å¥åº·çŠ¶æ€æ•°æ®ç»“æ„ ====================
    private static class ProviderHealth {
        AtomicInteger failureCount = new AtomicInteger(0);
        volatile long lastFailureTime = 0;

        void recordFailure() {
            failureCount.incrementAndGet();
            lastFailureTime = System.currentTimeMillis();
        }
    }
}
```

**ç†”æ–­å™¨çŠ¶æ€æœºï¼š**

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚            ç†”æ–­å™¨çŠ¶æ€æµè½¬                â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                                                 â”‚
     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
     â”‚     â”‚              â”‚   å¤±è´¥æ¬¡æ•° >= 5    â”‚              â”‚                       â”‚
     â”‚     â”‚    Closed    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     Open     â”‚                       â”‚
     â”‚     â”‚   (æ­£å¸¸)     â”‚                    â”‚   (ç†”æ–­)     â”‚                       â”‚
     â”‚     â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚                       â”‚
     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    æ¢å¤æˆåŠŸ        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
     â”‚            â”‚                                   â”‚                                â”‚
     â”‚            â”‚                                   â”‚ è¶…æ—¶ 60s                       â”‚
     â”‚            â”‚ æ¯æ¬¡è¯·æ±‚                          â”‚                                â”‚
     â”‚            â”‚ æˆåŠŸ: è®¡æ•°é‡ç½®                    â–¼                                â”‚
     â”‚            â”‚ å¤±è´¥: è®¡æ•° +1            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
     â”‚            â”‚                          â”‚  Half-Open   â”‚                         â”‚
     â”‚            â”‚                          â”‚   (åŠå¼€)     â”‚                         â”‚
     â”‚            â”‚                          â”‚ å°è¯•ä¸€æ¬¡è¯·æ±‚  â”‚                         â”‚
     â”‚            â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
     â”‚            â”‚                                   â”‚                                â”‚
     â”‚            â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â”‚            â”‚          â”‚                                                 â”‚      â”‚
     â”‚            â”‚          â–¼ æˆåŠŸ                                   å¤±è´¥ â–¼      â”‚
     â”‚            â””â”€â”€â”€â”€â”€â”€ å›åˆ° Closed                             å›åˆ° Open â”€â”€â”€â”€â”˜      â”‚
     â”‚                                                                                 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**2. RAG æ£€ç´¢é“¾è·¯**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: RagServiceImpl.java

@Slf4j
@Service
@RequiredArgsConstructor
public class RagServiceImpl implements RagService {

    private final EmbeddingModel embeddingModel;
    private final RestHighLevelClient restHighLevelClient;
    
    private static final String INDEX_NAME = "jelly_knowledge";
    private static final int CHUNK_SIZE = 500;    // åˆ†ç‰‡å¤§å°
    private static final int CHUNK_OVERLAP = 50;  // åˆ†ç‰‡é‡å 

    // ==================== æ–‡æ¡£ä¸Šä¼ ä¸å‘é‡åŒ– ====================
    @Override
    public Long uploadDocument(MultipartFile file) {
        // 1. è§£ææ–‡æ¡£å†…å®¹ï¼ˆæ”¯æŒ PDF/Word/TXTï¼‰
        String content = new Tika().parseToString(file.getInputStream());
        
        // 2. æ–‡æœ¬åˆ†ç‰‡ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
        List<String> chunks = splitToChunks(content);
        
        // 3. å‘é‡åŒ–å¹¶å­˜å…¥ ES
        for (int i = 0; i < chunks.size(); i++) {
            String chunk = chunks.get(i);
            
            // è°ƒç”¨ Embedding æ¨¡å‹
            Embedding embedding = embeddingModel.embed(chunk).content();
            float[] vector = embedding.vector();
            
            // æ„å»º ES æ–‡æ¡£
            Map<String, Object> esDoc = new HashMap<>();
            esDoc.put("doc_id", docId);
            esDoc.put("chunk_index", i);
            esDoc.put("content", chunk);
            esDoc.put("embedding", vector);
            
            // å†™å…¥ ES
            IndexRequest request = new IndexRequest(INDEX_NAME)
                    .id(docId + "_" + i)
                    .source(esDoc, XContentType.JSON);
            restHighLevelClient.index(request, RequestOptions.DEFAULT);
        }
        
        return docId;
    }

    // ==================== å‘é‡æ£€ç´¢ ====================
    @Override
    public String retrieve(String query, int topK) {
        // 1. æŸ¥è¯¢å‘é‡åŒ–
        Embedding queryEmbedding = embeddingModel.embed(query).content();
        float[] queryVector = queryEmbedding.vector();

        // 2. ES 7.6 å‘é‡æ£€ç´¢ï¼ˆscript_score + cosineSimilarityï¼‰
        Map<String, Object> params = Map.of("query_vector", queryVector);
        Script script = new Script(ScriptType.INLINE, "painless",
                "cosineSimilarity(params.query_vector, 'embedding') + 1.0", params);

        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()
                .query(QueryBuilders.scriptScoreQuery(QueryBuilders.matchAllQuery(), script))
                .size(topK);

        // 3. æ‰§è¡Œæ£€ç´¢
        SearchResponse response = restHighLevelClient.search(
                new SearchRequest(INDEX_NAME).source(sourceBuilder), 
                RequestOptions.DEFAULT);

        // 4. ç»„è£…ä¸Šä¸‹æ–‡
        List<String> contexts = new ArrayList<>();
        for (SearchHit hit : response.getHits().getHits()) {
            contexts.add((String) hit.getSourceAsMap().get("content"));
        }

        return String.join("\n\n---\n\n", contexts);
    }

    // ==================== æ–‡æœ¬åˆ†ç‰‡ï¼ˆæ»‘åŠ¨çª—å£ï¼‰ ====================
    private List<String> splitToChunks(String text) {
        List<String> chunks = new ArrayList<>();
        int start = 0;
        
        while (start < text.length()) {
            int end = Math.min(start + CHUNK_SIZE, text.length());
            
            // åœ¨å¥å·å¤„æ–­å¼€ï¼ˆæ›´åˆç†çš„åˆ†ç‰‡è¾¹ç•Œï¼‰
            if (end < text.length()) {
                for (int i = end; i > start + CHUNK_SIZE / 2; i--) {
                    char c = text.charAt(i);
                    if (c == 'ã€‚' || c == '.' || c == 'ï¼Ÿ' || c == '?') {
                        end = i + 1;
                        break;
                    }
                }
            }
            
            chunks.add(text.substring(start, end).trim());
            start = end - CHUNK_OVERLAP;  // æ»‘åŠ¨çª—å£é‡å 
        }
        
        return chunks;
    }
}
```

**RAG å®Œæ•´æµç¨‹å›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 RAG æ£€ç´¢å¢å¼ºç”Ÿæˆæµç¨‹                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                       â”‚
â”‚   â”‚  ç”¨æˆ·æé—®   â”‚  "å‘¨æ˜Ÿé©°æœ‰å“ªäº›ç»å…¸ç”µå½±ï¼Ÿ"                                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                                       â”‚
â”‚          â”‚                                                                              â”‚
â”‚          â–¼                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 1: Query å‘é‡åŒ–                                                            â”‚  â”‚
â”‚   â”‚  ä½¿ç”¨ BGE-M3 æ¨¡å‹å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸º 1024 ç»´å‘é‡                                      â”‚  â”‚
â”‚   â”‚  [0.023, -0.156, 0.089, ..., 0.045]                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                                              â”‚
â”‚          â–¼                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 2: ES å‘é‡å¬å› (Top 3)                                                      â”‚  â”‚
â”‚   â”‚  ä½¿ç”¨ cosineSimilarity è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå¬å›æœ€ç›¸å…³çš„çŸ¥è¯†ç‰‡æ®µ                              â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚  Result 1 (score=0.92): "å‘¨æ˜Ÿé©°ä»£è¡¨ä½œåŒ…æ‹¬ã€Šå¤§è¯è¥¿æ¸¸ã€‹ã€ŠåŠŸå¤«ã€‹ã€Šå°‘æ—è¶³çƒã€‹..."        â”‚  â”‚
â”‚   â”‚  Result 2 (score=0.87): "ã€Šå¤§è¯è¥¿æ¸¸ã€‹äº1995å¹´ä¸Šæ˜ ï¼Œç”±å‘¨æ˜Ÿé©°ä¸»æ¼”..."                 â”‚  â”‚
â”‚   â”‚  Result 3 (score=0.81): "å‘¨æ˜Ÿé©°è¢«èª‰ä¸º'å–œå‰§ä¹‹ç‹'ï¼Œæ— å˜å¤´é£æ ¼å½±å“æ·±è¿œ..."             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                                              â”‚
â”‚          â–¼                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 3: Prompt æ„é€                                                               â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚  System: ä½ æ˜¯ä¸€ä¸ªç”µå½±çŸ¥è¯†ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹å·²çŸ¥ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚                       â”‚  â”‚
â”‚   â”‚          å¦‚æœæ— æ³•ä»ä¿¡æ¯ä¸­å¾—åˆ°ç­”æ¡ˆï¼Œè¯·è¯´"æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¿¡æ¯"ã€‚                   â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚          å·²çŸ¥ä¿¡æ¯:                                                                 â”‚  â”‚
â”‚   â”‚          {å¬å›çš„çŸ¥è¯†ç‰‡æ®µ}                                                          â”‚  â”‚
â”‚   â”‚          ---                                                                      â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚  User: å‘¨æ˜Ÿé©°æœ‰å“ªäº›ç»å…¸ç”µå½±ï¼Ÿ                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                                              â”‚
â”‚          â–¼                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 4: LLM ç”Ÿæˆå›ç­”ï¼ˆæµå¼è¾“å‡ºï¼‰                                                   â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚  "å‘¨æ˜Ÿé©°çš„ç»å…¸ç”µå½±åŒ…æ‹¬ï¼š                                                            â”‚  â”‚
â”‚   â”‚   1. ã€Šå¤§è¯è¥¿æ¸¸ã€‹(1995) - ç»å…¸çˆ±æƒ…å–œå‰§                                              â”‚  â”‚
â”‚   â”‚   2. ã€ŠåŠŸå¤«ã€‹(2004) - åŠ¨ä½œå–œå‰§å·…å³°ä¹‹ä½œ                                              â”‚  â”‚
â”‚   â”‚   3. ã€Šå°‘æ—è¶³çƒã€‹(2001) - ä½“è‚²å–œå‰§..."                                             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**3. æµå¼å“åº”å®ç°**

```java
// é¡¹ç›®å®é™…ä»£ç ä½ç½®: ChatServiceImpl.java

@Override
public Flux<String> chatStream(ChatRequestDTO dto) {
    List<ChatMessage> messages = buildMessages(dto);

    // ä½¿ç”¨ Reactor Sinks å®ç°èƒŒå‹æ§åˆ¶
    Sinks.Many<String> sink = Sinks.many().unicast().onBackpressureBuffer();

    // è°ƒç”¨æµå¼æ¨¡å‹
    streamingChatLanguageModel.generate(messages, new StreamingResponseHandler<AiMessage>() {
        @Override
        public void onNext(String token) {
            // é€ token æ¨é€ï¼ˆæ¯ä¸ªå­—/è¯ï¼‰
            sink.tryEmitNext(token);
        }

        @Override
        public void onComplete(Response<AiMessage> response) {
            // å®Œæˆä¿¡å·
            sink.tryEmitComplete();
        }

        @Override
        public void onError(Throwable error) {
            log.error("æµå¼å¯¹è¯é”™è¯¯", error);
            // é”™è¯¯ä¼ æ’­åˆ°å®¢æˆ·ç«¯
            sink.tryEmitError(error);
        }
    });

    return sink.asFlux();
}

// Controller å±‚ SSE ç«¯ç‚¹
@PostMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> chatStream(@RequestBody ChatRequestDTO dto) {
    return chatService.chatStream(dto)
            .onErrorResume(e -> {
                // é”™è¯¯æ—¶è¿”å›å‹å¥½æç¤º
                return Flux.just("[ERROR] AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
            });
}
```

---

## å››ã€æŠ€æœ¯äº®ç‚¹æ·±åº¦å‰–æï¼ˆé¢è¯•ç‰ˆï¼‰

> ğŸ’¡ **ä½¿ç”¨åœºæ™¯**ï¼šæŠ€æœ¯é¢è¯•æ·±åº¦è¿½é—®ã€æŠ€æœ¯æ–¹æ¡ˆè®¨è®º

### 4.1 Sentinel é™æµç†”æ–­æ–¹æ¡ˆ

#### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Sentinel é™æµç†”æ–­æ¶æ„                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                         ç½‘å…³å±‚é™æµ (Gateway Flow)                               â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  è§„åˆ™ç±»å‹ï¼šGatewayFlowRule                                               â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  é™æµç»´åº¦ï¼šRoute ID / API åˆ†ç»„                                           â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  é™æµç­–ç•¥ï¼š                                                              â”‚  â”‚    â”‚
â”‚   â”‚  â”‚    â€¢ QPS é™æµï¼ˆç›´æ¥æ‹’ç»ï¼‰                                                â”‚  â”‚    â”‚
â”‚   â”‚  â”‚    â€¢ çº¿ç¨‹æ•°é™æµï¼ˆå¹¶å‘æ§åˆ¶ï¼‰                                              â”‚  â”‚    â”‚
â”‚   â”‚  â”‚    â€¢ åŒ€é€Ÿæ’é˜Ÿï¼ˆæ¼æ¡¶ç®—æ³•ï¼‰                                                â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚                                               â”‚
â”‚                                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                         åº”ç”¨å±‚é™æµ (@SentinelResource)                         â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  æ³¨è§£æ–¹å¼ï¼š@SentinelResource(value="xxx", fallback="xxxFallback")        â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  é™æµç±»å‹ï¼š                                                              â”‚  â”‚    â”‚
â”‚   â”‚  â”‚    â€¢ çƒ­ç‚¹å‚æ•°é™æµï¼ˆå¦‚ï¼šfilmIdã€userIdï¼‰                                   â”‚  â”‚    â”‚
â”‚   â”‚  â”‚    â€¢ æ¥å£çº§åˆ«é™æµ                                                        â”‚  â”‚    â”‚
â”‚   â”‚  â”‚    â€¢ ç†”æ–­é™çº§ï¼ˆRT/å¼‚å¸¸æ¯”ä¾‹/å¼‚å¸¸æ•°ï¼‰                                       â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚                                               â”‚
â”‚                                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                         è§„åˆ™æŒä¹…åŒ– (Nacos DataSource)                          â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  é…ç½®ä¸­å¿ƒï¼šNacos                                                         â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  è§„åˆ™ç±»å‹ï¼šflow-rules / degrade-rules / param-flow-rules                  â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  åŠ¨æ€æ›´æ–°ï¼šè§„åˆ™å˜æ›´å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯                                      â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…ç½®ç¤ºä¾‹

```yaml
# application.yml - ç½‘å…³å±‚ Sentinel é…ç½®
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8858
        port: 8719
      datasource:
        # ç½‘å…³æµæ§è§„åˆ™
        gw-flow:
          nacos:
            server-addr: ${NACOS_SERVER:localhost:8848}
            data-id: ${spring.application.name}-gw-flow-rules
            group-id: SENTINEL_GROUP
            rule-type: gw-flow
        # ç†”æ–­é™çº§è§„åˆ™
        degrade:
          nacos:
            server-addr: ${NACOS_SERVER:localhost:8848}
            data-id: ${spring.application.name}-degrade-rules
            group-id: SENTINEL_GROUP
            rule-type: degrade
```

```json
// Nacos ä¸­çš„ç½‘å…³é™æµè§„åˆ™ç¤ºä¾‹
[
  {
    "resource": "jelly-film",
    "resourceMode": 0,
    "count": 100,
    "intervalSec": 1,
    "controlBehavior": 0,
    "burst": 20,
    "maxQueueingTimeoutMs": 500
  },
  {
    "resource": "jelly-ai",
    "resourceMode": 0,
    "count": 10,
    "intervalSec": 1,
    "controlBehavior": 2,
    "maxQueueingTimeoutMs": 2000
  }
]
```

#### é¢è¯•é—®ç­”é›†

| é—®é¢˜ | å›ç­”è¦ç‚¹ |
|------|---------|
| **Q1: ç½‘å…³é™æµå’Œåº”ç”¨é™æµæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ** | ç½‘å…³é™æµæ˜¯**å…¥å£é˜²æŠ¤**ï¼ŒæŒ‰è·¯ç”± ID é™æµï¼Œé˜²æ­¢å•æœåŠ¡è¢«æ‰“çˆ†ï¼›åº”ç”¨é™æµæ˜¯**ç²¾ç»†åŒ–æ§åˆ¶**ï¼Œå¯é’ˆå¯¹çƒ­ç‚¹å‚æ•°ã€ç‰¹å®šæ–¹æ³•åšé™æµã€‚æˆ‘ä»¬é‡‡ç”¨**ä¸¤çº§é™æµ**ï¼šç½‘å…³å±‚é˜² DDoSï¼Œåº”ç”¨å±‚é˜²çƒ­ç‚¹ã€‚ |
| **Q2: é™æµç®—æ³•æœ‰å“ªäº›ï¼Ÿä½ ä»¬ç”¨çš„æ˜¯å“ªç§ï¼Ÿ** | å¸¸è§ç®—æ³•ï¼šâ‘ è®¡æ•°å™¨ â‘¡æ»‘åŠ¨çª—å£ â‘¢æ¼æ¡¶ â‘£ä»¤ç‰Œæ¡¶ã€‚æˆ‘ä»¬ç½‘å…³å±‚ç”¨**æ»‘åŠ¨çª—å£**ï¼ˆé»˜è®¤ï¼‰ï¼ŒAI æ¥å£ç”¨**åŒ€é€Ÿæ’é˜Ÿ**ï¼ˆcontrolBehavior=2ï¼‰ï¼Œé¿å…çªå‘æµé‡å†²å‡» APIã€‚ |
| **Q3: é™æµè¢«è§¦å‘åæ€ä¹ˆå¤„ç†ï¼Ÿ** | â‘ è¿”å› 429 çŠ¶æ€ç  + å‹å¥½æç¤º â‘¡å‰ç«¯å±•ç¤ºå…œåº•æ•°æ®ï¼ˆç¼“å­˜æ¦œå•ï¼‰â‘¢è®°å½•é™æµæ—¥å¿—ç”¨äºå®¹é‡è§„åˆ’ â‘£Sentinel Dashboard å®æ—¶ç›‘æ§ |
| **Q4: ç†”æ–­å’Œé™æµæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ** | **é™æµ**ï¼šæ§åˆ¶è¯·æ±‚é€Ÿç‡ï¼Œé˜²æ­¢è¿‡è½½ï¼›**ç†”æ–­**ï¼šæ£€æµ‹ä¸‹æ¸¸æ•…éšœï¼Œå¿«é€Ÿå¤±è´¥ã€‚ç†”æ–­æœ‰ä¸‰ç§ç­–ç•¥ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°ã€‚æˆ‘ä»¬ AI æœåŠ¡ç”¨å¼‚å¸¸æ¯”ä¾‹ç†”æ–­ï¼ˆé˜ˆå€¼ 50%ï¼‰ã€‚ |

---

### 4.2 WebSocket å®æ—¶é€šè®¯æœºåˆ¶

#### è¿æ¥ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WebSocket è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   [1] æ¡æ‰‹é˜¶æ®µ                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Client                                              Server                      â”‚  â”‚
â”‚   â”‚    â”‚                                                    â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚  HTTP GET /ws/chat?token=xxx                      â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚  Upgrade: websocket                               â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚  Connection: Upgrade                              â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚                                                    â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚                    [Sa-Token éªŒè¯]                  â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚                    [æå– userId åˆ° Session]          â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚                                                    â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚  HTTP 101 Switching Protocols                     â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚  â”‚
â”‚   â”‚    â”‚                                                    â”‚                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â”‚   [2] è¿æ¥å»ºç«‹                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  afterConnectionEstablished(session)                                             â”‚  â”‚
â”‚   â”‚    â”‚                                                                             â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ ONLINE_SESSIONS.put(userId, session)  // æ³¨å†Œä¼šè¯                          â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ log.info("ç”¨æˆ·ä¸Šçº¿: {}", userId)                                           â”‚  â”‚
â”‚   â”‚    â””â”€â”€ notifyFriendsOnlineStatus(userId, true)  // å¹¿æ’­ä¸Šçº¿                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â”‚   [3] æ¶ˆæ¯æ”¶å‘                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  handleTextMessage(session, message)                                             â”‚  â”‚
â”‚   â”‚    â”‚                                                                             â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ è§£æ JSON â†’ MessageDTO                                                     â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ messageService.sendMessage(userId, dto)                                   â”‚  â”‚
â”‚   â”‚    â”‚     â”œâ”€â”€ å®æ—¶æ¨é€ç»™æ¥æ”¶æ–¹ï¼ˆWebSocketï¼‰                                         â”‚  â”‚
â”‚   â”‚    â”‚     â””â”€â”€ å¼‚æ­¥æŒä¹…åŒ–ï¼ˆRocketMQï¼‰                                                â”‚  â”‚
â”‚   â”‚    â””â”€â”€ å¼‚å¸¸æ—¶è°ƒç”¨ sendError(session, errorMsg)                                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â”‚   [4] è¿æ¥æ–­å¼€                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  afterConnectionClosed(session, status)                                          â”‚  â”‚
â”‚   â”‚    â”‚                                                                             â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ æ£€æŸ¥ session.getId() == storedSession.getId()  // é˜²æ­¢æ–°æ—§è¦†ç›–            â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ ONLINE_SESSIONS.remove(userId)                                            â”‚  â”‚
â”‚   â”‚    â””â”€â”€ notifyFriendsOnlineStatus(userId, false)  // å¹¿æ’­ä¸‹çº¿                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é¢è¯•é—®ç­”é›†

| é—®é¢˜ | å›ç­”è¦ç‚¹ |
|------|---------|
| **Q1: ä¸ºä»€ä¹ˆç”¨ WebSocket è€Œä¸æ˜¯è½®è¯¢ï¼Ÿ** | â‘ **å®æ—¶æ€§**ï¼šWebSocket æ˜¯å…¨åŒå·¥ï¼ŒæœåŠ¡ç«¯å¯ä¸»åŠ¨æ¨é€ï¼›è½®è¯¢æœ‰å»¶è¿Ÿ â‘¡**æ€§èƒ½**ï¼šä¸€æ¬¡æ¡æ‰‹é•¿è¿æ¥ï¼Œé¿å…é‡å¤å»ºç«‹è¿æ¥ â‘¢**å¸¦å®½**ï¼šæ—  HTTP å¤´å¼€é”€ï¼ŒèŠ‚çœæµé‡ |
| **Q2: å¦‚ä½•å¤„ç†è¿æ¥è¦†ç›–é—®é¢˜ï¼Ÿ** | åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿé‡è¿ï¼Œæ–°è¿æ¥å…ˆå»ºç«‹ï¼Œæ—§è¿æ¥åæ–­å¼€ã€‚æ–¹æ¡ˆï¼šæ–­å¼€æ—¶æ¯”å¯¹ `session.getId()`ï¼Œåªæœ‰å½“å‰å­˜å‚¨çš„ session æ‰ç§»é™¤ï¼Œé¿å…æ–°è¿æ¥è¢«è¯¯åˆ ã€‚ |
| **Q3: å¦‚ä½•å¤„ç†æ–­çº¿é‡è¿ï¼Ÿ** | â‘ æœåŠ¡ç«¯ï¼šè¿æ¥æ–­å¼€æ—¶**ä¸ç«‹å³æ¸…ç†**ï¼Œç­‰å¾… 30s è¶…æ—¶ â‘¡å®¢æˆ·ç«¯ï¼šæ£€æµ‹åˆ°æ–­å¼€å**æŒ‡æ•°é€€é¿é‡è¿**ï¼ˆ1sâ†’2sâ†’4sâ†’8sï¼Œæœ€å¤§ 30sï¼‰â‘¢æ¢å¤æ—¶åŒæ­¥ç¦»çº¿æ¶ˆæ¯ |
| **Q4: å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ** | â‘ **å®æ—¶æ¶ˆæ¯**ï¼šWebSocket æ¨é€ + ACK ç¡®è®¤ â‘¡**ç¦»çº¿æ¶ˆæ¯**ï¼šå­˜å…¥ Redis Listï¼Œä¸Šçº¿æ—¶æ‹‰å– â‘¢**æŒä¹…åŒ–**ï¼šRocketMQ å¼‚æ­¥è½åº“ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´ |
| **Q5: å¦‚ä½•å¤„ç†ç¾¤èŠå¹¿æ’­æ€§èƒ½ï¼Ÿ** | â‘ **éå†æ¨é€**ï¼šå°ç¾¤ï¼ˆ<100äººï¼‰ç›´æ¥éå† `sendToUsers` â‘¡**å¤§ç¾¤ä¼˜åŒ–**ï¼šåˆ†æ‰¹æ¨é€ + å¼‚æ­¥çº¿ç¨‹æ±  â‘¢**æ‰©å±•æ–¹æ¡ˆ**ï¼šRedis Pub/Sub å¤šèŠ‚ç‚¹å¹¿æ’­ |

---

### 4.3 RocketMQ å¼‚æ­¥å‰Šå³°

#### æ¶ˆæ¯æµè½¬æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              RocketMQ æ¶ˆæ¯æµè½¬æ¶æ„                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                              ç”Ÿäº§è€… (Producer)                                   â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚  MessageProducer.sendMessage(ChatMessage)                                â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â”‚                                                                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ JSON åºåˆ—åŒ–                                                       â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ rocketMQTemplate.convertAndSend("IM_MSG_SEND", json)             â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â””â”€â”€ å¼‚å¸¸æ—¶åŒæ­¥å†™å…¥ MySQLï¼ˆå…œåº•ï¼‰                                        â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                                               â”‚
â”‚                                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                              Broker (RocketMQ)                                   â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚  Topic: IM_MSG_SEND                                                      â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚ Queue 0 â”‚  â”‚ Queue 1 â”‚  â”‚ Queue 2 â”‚  â”‚ Queue 3 â”‚                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚ msg1    â”‚  â”‚ msg2    â”‚  â”‚ msg3    â”‚  â”‚ msg4    â”‚                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â”‚ msg5    â”‚  â”‚ msg6    â”‚  â”‚ msg7    â”‚  â”‚ msg8    â”‚                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                          â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  ç‰¹æ€§ï¼š                                                                   â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â€¢ æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆç£ç›˜å­˜å‚¨ï¼‰                                                  â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â€¢ æ¶ˆæ¯å †ç§¯ï¼ˆæ”¯æŒäº¿çº§ï¼‰                                                    â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  â€¢ æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰                                                        â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                                               â”‚
â”‚                                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                              æ¶ˆè´¹è€… (Consumer)                                   â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚  @RocketMQMessageListener(                                               â”‚   â”‚  â”‚
â”‚   â”‚  â”‚      topic = "IM_MSG_SEND",                                              â”‚   â”‚  â”‚
â”‚   â”‚  â”‚      consumerGroup = "im-consumer-group",                                â”‚   â”‚  â”‚
â”‚   â”‚  â”‚      consumeMode = ConsumeMode.ORDERLY  // å¯é€‰ï¼šé¡ºåºæ¶ˆè´¹                  â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  )                                                                       â”‚   â”‚  â”‚
â”‚   â”‚  â”‚                                                                          â”‚   â”‚  â”‚
â”‚   â”‚  â”‚  onMessage(String message)                                               â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â”‚                                                                     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ JSON ååºåˆ—åŒ– â†’ ChatMessage                                        â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ chatMessageMapper.insert(chatMessage)  // å†™å…¥ MySQL              â”‚   â”‚  â”‚
â”‚   â”‚  â”‚    â””â”€â”€ å¼‚å¸¸æ—¶æŠ›å‡º RuntimeException â†’ è§¦å‘é‡è¯•                              â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é¢è¯•é—®ç­”é›†

| é—®é¢˜ | å›ç­”è¦ç‚¹ |
|------|---------|
| **Q1: ä¸ºä»€ä¹ˆç”¨ MQ åšå¼‚æ­¥æŒä¹…åŒ–ï¼Ÿ** | â‘ **å‰Šå³°**ï¼šé«˜å³°æœŸæ¶ˆæ¯å…ˆå †ç§¯åœ¨ MQï¼Œæ¶ˆè´¹è€…åŒ€é€Ÿå¤„ç† â‘¡**è§£è€¦**ï¼šå‘é€å’Œå­˜å‚¨åˆ†ç¦»ï¼Œäº’ä¸å½±å“ â‘¢**å¯é æ€§**ï¼šMQ æŒä¹…åŒ–ä¿è¯æ¶ˆæ¯ä¸ä¸¢ |
| **Q2: æ¶ˆæ¯å †ç§¯æ€ä¹ˆå¤„ç†ï¼Ÿ** | â‘ **ç›‘æ§**ï¼šå †ç§¯é‡è¶…è¿‡é˜ˆå€¼å‘Šè­¦ â‘¡**æ‰©å®¹**ï¼šå¢åŠ æ¶ˆè´¹è€…å®ä¾‹ï¼ˆæ°´å¹³æ‰©å±•ï¼‰â‘¢**é™çº§**ï¼šä¸¢å¼ƒéå…³é”®æ¶ˆæ¯ â‘£**TTL**ï¼šè¿‡æœŸæ¶ˆæ¯è‡ªåŠ¨æ¸…ç† |
| **Q3: å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ** | **ä¸‰ä¸ªé˜¶æ®µ**ï¼šâ‘ ç”Ÿäº§ç«¯ï¼šåŒæ­¥å‘é€ + é‡è¯• â‘¡Brokerï¼šåŒæ­¥åˆ·ç›˜ + ä¸»ä»åŒæ­¥ â‘¢æ¶ˆè´¹ç«¯ï¼šæ‰‹åŠ¨ ACK + é‡è¯•æœºåˆ¶ |
| **Q4: å¦‚ä½•ä¿è¯æ¶ˆæ¯å¹‚ç­‰ï¼Ÿ** | â‘ **æ•°æ®åº“å”¯ä¸€é”®**ï¼šmsgId ä½œä¸ºå”¯ä¸€ç´¢å¼•ï¼ŒINSERT IGNORE â‘¡**Redis å»é‡**ï¼šæ¶ˆè´¹å‰æ£€æŸ¥ SETNX(msgId, 1, TTL=24h) â‘¢**çŠ¶æ€æœº**ï¼šæ¶ˆæ¯å¸¦çŠ¶æ€å­—æ®µï¼Œåªå¤„ç†ç‰¹å®šçŠ¶æ€ |
| **Q5: é¡ºåºæ¶ˆæ¯æ€ä¹ˆå®ç°ï¼Ÿ** | â‘ **å…¨å±€é¡ºåº**ï¼šå• Queue + å• Consumerï¼ˆæ€§èƒ½å·®ï¼‰â‘¡**å±€éƒ¨é¡ºåº**ï¼šæŒ‰ sessionId å“ˆå¸Œåˆ°å›ºå®š Queueï¼ˆæ¨èï¼‰â‘¢é…ç½® `consumeMode = ConsumeMode.ORDERLY` |

---

### 4.4 å¤šçº§ç¼“å­˜ç­–ç•¥

#### ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¤šçº§ç¼“å­˜æ¶æ„è¯¦è§£                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                              L1: Caffeine æœ¬åœ°ç¼“å­˜                              â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  ç‰¹ç‚¹ï¼š                                                                  â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ è¿›ç¨‹å†…å­˜å‚¨ï¼Œæ— ç½‘ç»œå¼€é”€                                                 â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ RT < 1msï¼ˆçº³ç§’çº§ï¼‰                                                     â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ å®¹é‡æœ‰é™ï¼ˆ100-1000 æ¡ï¼‰                                                â”‚  â”‚    â”‚
â”‚   â”‚  â”‚                                                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  é€‚ç”¨åœºæ™¯ï¼š                                                               â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ å˜åŒ–é¢‘ç‡ä½çš„é…ç½®æ•°æ®ï¼ˆåˆ†ç±»ã€æ ‡ç­¾ï¼‰                                      â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ çƒ­ç‚¹æ•°æ®æœ¬åœ°å‰¯æœ¬                                                       â”‚  â”‚    â”‚
â”‚   â”‚  â”‚                                                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  é…ç½®ç¤ºä¾‹ï¼š                                                               â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  Caffeine.newBuilder()                                                   â”‚  â”‚    â”‚
â”‚   â”‚  â”‚      .maximumSize(100)                                                   â”‚  â”‚    â”‚
â”‚   â”‚  â”‚      .expireAfterWrite(10, TimeUnit.MINUTES)                             â”‚  â”‚    â”‚
â”‚   â”‚  â”‚      .recordStats()  // å¼€å¯ç»Ÿè®¡                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚      .build();                                                           â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚ æœªå‘½ä¸­                                        â”‚
â”‚                                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                              L2: Redis åˆ†å¸ƒå¼ç¼“å­˜                               â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  ç‰¹ç‚¹ï¼š                                                                  â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ è·¨è¿›ç¨‹å…±äº«ï¼Œæ”¯æŒé›†ç¾¤                                                   â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ RT < 5msï¼ˆç½‘ç»œ RTTï¼‰                                                   â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ å®¹é‡å¤§ï¼ˆGB çº§ï¼‰                                                        â”‚  â”‚    â”‚
â”‚   â”‚  â”‚                                                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  æ•°æ®ç»“æ„é€‰æ‹©ï¼š                                                           â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ String: ç®€å• KVï¼ˆç”µå½±è¯¦æƒ…ï¼‰                                            â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ Hash: ç»“æ„åŒ–æ•°æ®ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰                                           â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ ZSet: æ’è¡Œæ¦œï¼ˆçƒ­é—¨æ¦œå•ï¼‰                                               â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ Set: å»é‡é›†åˆï¼ˆæŠ•ç¥¨è®°å½•ï¼‰                                              â”‚  â”‚    â”‚
â”‚   â”‚  â”‚                                                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  Key è®¾è®¡è§„èŒƒï¼š                                                           â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ jelly:film:detail:{id}     ç”µå½±è¯¦æƒ…                                    â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ jelly:film:hot:rank        çƒ­é—¨æ¦œå•                                    â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ jelly:user:session:{token} ç”¨æˆ·ä¼šè¯                                    â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚ æœªå‘½ä¸­                                        â”‚
â”‚                                         â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                              L3: MySQL æ•°æ®åº“                                   â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  ç‰¹ç‚¹ï¼š                                                                  â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ æ•°æ®æŒä¹…åŒ–ï¼Œå¼ºä¸€è‡´æ€§                                                   â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ RT 10-50msï¼ˆå–å†³äºæŸ¥è¯¢å¤æ‚åº¦ï¼‰                                         â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ æ”¯æŒå¤æ‚æŸ¥è¯¢                                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚                                                                          â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  æŸ¥è¯¢åæ“ä½œï¼š                                                             â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ å†™å…¥ Redisï¼ˆTTL=30min + éšæœºåç§»ï¼‰                                     â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  â€¢ å†™å…¥ Caffeineï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰                                              â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | ç°è±¡ | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **ç©¿é€** | æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œæ¯æ¬¡éƒ½æ‰“åˆ° DB | â‘ ç¼“å­˜ç©ºå€¼ï¼ˆTTL=5minï¼‰â‘¡å¸ƒéš†è¿‡æ»¤å™¨å‰ç½®æ‹¦æˆª |
| **å‡»ç©¿** | çƒ­ç‚¹ Key è¿‡æœŸç¬é—´ï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ° DB | â‘ äº’æ–¥é”ï¼ˆRedissonï¼‰â‘¡é€»è¾‘è¿‡æœŸï¼ˆå¼‚æ­¥æ›´æ–°ï¼‰â‘¢æ°¸ä¸è¿‡æœŸ + åå°åˆ·æ–° |
| **é›ªå´©** | å¤§é‡ Key åŒæ—¶è¿‡æœŸï¼ŒDB å‹åŠ›éª¤å¢ | â‘ TTL éšæœºåŒ–ï¼ˆåŸºç¡€å€¼ Â± 20%ï¼‰â‘¡ç†”æ–­é™çº§ â‘¢ç¼“å­˜é¢„çƒ­ |
| **ä¸€è‡´æ€§** | ç¼“å­˜ä¸ DB æ•°æ®ä¸ä¸€è‡´ | â‘ Cache-Asideï¼šå…ˆæ›´æ–° DBï¼Œå†åˆ é™¤ç¼“å­˜ â‘¡å»¶è¿ŸåŒåˆ  â‘¢è®¢é˜… binlog |

#### é¢è¯•é—®ç­”é›†

| é—®é¢˜ | å›ç­”è¦ç‚¹ |
|------|---------|
| **Q1: ä¸ºä»€ä¹ˆç”¨ä¸¤çº§ç¼“å­˜ï¼Ÿ** | â‘ **Caffeine**ï¼šé¿å…ç½‘ç»œå¼€é”€ï¼Œæé€Ÿå“åº”ï¼ˆ<1msï¼‰â‘¡**Redis**ï¼šå¤šå®ä¾‹å…±äº«ï¼Œæ•°æ®ä¸€è‡´ â‘¢åˆ†å±‚é˜²æŠ¤ï¼Œä»»ä¸€å±‚æ•…éšœä¸å½±å“æœåŠ¡ |
| **Q2: ç¼“å­˜æ›´æ–°ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ** | æˆ‘ä»¬ç”¨ **Cache-Aside**ï¼šè¯»æ—¶å…ˆæŸ¥ç¼“å­˜ï¼Œæœªå‘½ä¸­æŸ¥ DB å†å†™ç¼“å­˜ï¼›å†™æ—¶å…ˆæ›´æ–° DBï¼Œå†åˆ é™¤ç¼“å­˜ï¼ˆä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Œé¿å…å¹¶å‘é—®é¢˜ï¼‰ |
| **Q3: æœ¬åœ°ç¼“å­˜å’Œ Redis å¦‚ä½•ä¿æŒä¸€è‡´ï¼Ÿ** | â‘ **æœ€ç»ˆä¸€è‡´**ï¼šæœ¬åœ°ç¼“å­˜è®¾çŸ­ TTLï¼ˆ10minï¼‰ï¼Œä¾èµ–è¿‡æœŸ â‘¡**ä¸»åŠ¨å¤±æ•ˆ**ï¼šRedis Pub/Sub å¹¿æ’­å¤±æ•ˆäº‹ä»¶ â‘¢**å…³é”®æ•°æ®**ï¼šä¸èµ°æœ¬åœ°ç¼“å­˜ |
| **Q4: ç¼“å­˜å‘½ä¸­ç‡æ€ä¹ˆç›‘æ§ï¼Ÿ** | â‘ Caffeineï¼š`recordStats()` + `cache.stats()` â‘¡Redisï¼š`INFO stats` æŸ¥çœ‹ keyspace_hits/keyspace_misses â‘¢è‡ªå®šä¹‰åŸ‹ç‚¹ä¸ŠæŠ¥ Prometheus |

---

### 4.5 Elasticsearch æœç´¢ä¼˜åŒ–

#### ç´¢å¼•è®¾è®¡

```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_smart_pinyin": {
          "type": "custom",
          "tokenizer": "ik_smart",
          "filter": ["lowercase", "pinyin_filter"]
        }
      },
      "filter": {
        "pinyin_filter": {
          "type": "pinyin",
          "keep_original": true,
          "keep_first_letter": true
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "pinyin": {
            "type": "text",
            "analyzer": "ik_smart_pinyin"
          }
        }
      },
      "description": { "type": "text", "analyzer": "ik_max_word" },
      "actors": { "type": "text", "analyzer": "ik_max_word" },
      "director": { "type": "text", "analyzer": "ik_max_word" },
      "tags": { "type": "keyword" },
      "rating": { "type": "float" },
      "playCount": { "type": "long" },
      "year": { "type": "integer" },
      "embedding": { "type": "dense_vector", "dims": 1024 },
      "createTime": { "type": "date" }
    }
  }
}
```

#### é¢è¯•é—®ç­”é›†

| é—®é¢˜ | å›ç­”è¦ç‚¹ |
|------|---------|
| **Q1: ik_max_word å’Œ ik_smart åŒºåˆ«ï¼Ÿ** | `ik_max_word`ï¼šæœ€ç»†ç²’åº¦ï¼Œ"ä¸­åäººæ°‘å…±å’Œå›½"â†’7ä¸ªè¯ï¼›`ik_smart`ï¼šæ™ºèƒ½åˆ‡åˆ†â†’2ä¸ªè¯ã€‚**ç´¢å¼•ç”¨ max_word æé«˜å¬å›ï¼Œæœç´¢ç”¨ smart æé«˜ç²¾åº¦**ã€‚ |
| **Q2: å¦‚ä½•å®ç°æœç´¢é«˜äº®ï¼Ÿ** | ä½¿ç”¨ `highlight` APIï¼š`sourceBuilder.highlighter(new HighlightBuilder().field("title").preTags("<em>").postTags("</em>"))` |
| **Q3: å‘é‡æ£€ç´¢åŸç†ï¼Ÿ** | â‘ æ–‡æœ¬é€šè¿‡ Embedding æ¨¡å‹ï¼ˆBGE-M3ï¼‰è½¬ä¸º 1024 ç»´å‘é‡ â‘¡ES å­˜å‚¨å‘é‡å­—æ®µï¼ˆdense_vectorï¼‰â‘¢æŸ¥è¯¢æ—¶è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosineSimilarityï¼‰â‘£è¿”å› Top K ç»“æœ |
| **Q4: æ··åˆæ£€ç´¢å¦‚ä½•èåˆï¼Ÿ** | â‘ BM25 å…³é”®è¯å¬å› Top 2N â‘¡å‘é‡è¯­ä¹‰å¬å› Top N â‘¢ç»“æœèåˆï¼šRRFï¼ˆå€’æ•°æ’åèåˆï¼‰æˆ–çº¿æ€§åŠ æƒ â‘£å»é‡è¿”å› |
| **Q5: æœç´¢æ€§èƒ½ä¼˜åŒ–ï¼Ÿ** | â‘ **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†åˆ†ç‰‡ã€ç¦ç”¨ _source å‹ç¼© â‘¡**æŸ¥è¯¢ä¼˜åŒ–**ï¼šé¿å…æ·±åº¦åˆ†é¡µï¼ˆç”¨ search_afterï¼‰â‘¢**ç¼“å­˜**ï¼šçƒ­é—¨æŸ¥è¯¢ç¼“å­˜åˆ° Redis â‘£**é¢„çƒ­**ï¼šå¯åŠ¨æ—¶åŠ è½½çƒ­è¯ |

---

### 4.6 AI æœåŠ¡æ•…éšœè½¬ç§»

#### é¢è¯•é—®ç­”é›†

| é—®é¢˜ | å›ç­”è¦ç‚¹ |
|------|---------|
| **Q1: ä¸ºä»€ä¹ˆè¦å¤šæä¾›å•†ï¼Ÿ** | â‘ **å¯ç”¨æ€§**ï¼šå•ä¸€æä¾›å•†å®•æœºæ—¶è‡ªåŠ¨åˆ‡æ¢ â‘¡**æˆæœ¬**ï¼šä¸åŒåœºæ™¯ç”¨ä¸åŒæ¨¡å‹ï¼ˆç®€å•é—®é¢˜ç”¨ä¾¿å®œæ¨¡å‹ï¼‰â‘¢**æ€§èƒ½**ï¼šè´Ÿè½½å‡è¡¡åˆ†æ•£å‹åŠ› |
| **Q2: ç†”æ–­å™¨å·¥ä½œåŸç†ï¼Ÿ** | ä¸‰æ€æ¨¡å‹ï¼š**Closed**ï¼ˆæ­£å¸¸ï¼‰â†’å¤±è´¥è¶…é˜ˆå€¼â†’**Open**ï¼ˆç†”æ–­ï¼‰â†’è¶…æ—¶åâ†’**Half-Open**ï¼ˆæ¢æµ‹ï¼‰â†’æˆåŠŸå› Closed/å¤±è´¥å› Open |
| **Q3: å¦‚ä½•å®ç°æµå¼å“åº”ï¼Ÿ** | â‘ åç«¯ï¼š`StreamingChatLanguageModel` + `Sinks.Many` é€ token æ¨é€ â‘¡ä¼ è¾“ï¼šSSEï¼ˆServer-Sent Eventsï¼‰â‘¢å‰ç«¯ï¼šEventSource ç›‘å¬ `onmessage` äº‹ä»¶ |
| **Q4: RAG æ£€ç´¢å¦‚ä½•ä¼˜åŒ–ï¼Ÿ** | â‘ **åˆ†ç‰‡**ï¼šæ»‘åŠ¨çª—å£ + å¥å­è¾¹ç•Œæ–­å¼€ â‘¡**å¬å›**ï¼šTop K å¯é…ç½®ï¼ˆé»˜è®¤ 3ï¼‰â‘¢**é‡æ’åº**ï¼šå¯åŠ  Cross-Encoder ç²¾æ’ â‘£**ç¼“å­˜**ï¼šç›¸ä¼¼æŸ¥è¯¢å¤ç”¨ç»“æœ |

---

## äº”ã€é¡¹ç›®éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 5.1 éš¾ç‚¹æ¸…å•

| # | éš¾ç‚¹ | åœºæ™¯æè¿° | è§£å†³æ–¹æ¡ˆ |
|---|------|---------|---------|
| 1 | **WebSocket è¿æ¥è¦†ç›–** | ç”¨æˆ·å¿«é€Ÿé‡è¿æ—¶ï¼Œæ–°è¿æ¥å»ºç«‹åæ—§è¿æ¥æ–­å¼€äº‹ä»¶è¦†ç›–æ–°è¿æ¥ | æ–­å¼€æ—¶æ¯”å¯¹ SessionIdï¼Œåªç§»é™¤åŒ¹é…çš„ Session |
| 2 | **JS å¤§æ•°å­—ç²¾åº¦ä¸¢å¤±** | Long ç±»å‹ userId ä¼ åˆ°å‰ç«¯å˜æˆè¿‘ä¼¼å€¼ | userId è½¬ String ä¼ è¾“ï¼Œå‰ç«¯ç”¨ BigInt æˆ–å­—ç¬¦ä¸²å¤„ç† |
| 3 | **AI æœåŠ¡ä¸ç¨³å®š** | ç¬¬ä¸‰æ–¹ API è¶…æ—¶ã€é™æµã€å®•æœº | å¤šæä¾›å•†è·¯ç”± + ç†”æ–­å™¨ + è‡ªåŠ¨æ•…éšœè½¬ç§» |
| 4 | **ES 7.6 å‘é‡æ£€ç´¢** | ä¸æ”¯æŒåŸç”Ÿ KNNï¼Œdense_vector æŸ¥è¯¢å¤æ‚ | ä½¿ç”¨ script_score + cosineSimilarity å®ç° |
| 5 | **ç¼“å­˜ä¸€è‡´æ€§** | å¤šçº§ç¼“å­˜æ•°æ®ä¸ä¸€è‡´ | æœ¬åœ°ç¼“å­˜çŸ­ TTL + Redis Pub/Sub å¤±æ•ˆé€šçŸ¥ |
| 6 | **æ¶ˆæ¯é¡ºåºæ€§** | ç¾¤èŠæ¶ˆæ¯ä¹±åº | RocketMQ é¡ºåºæ¶ˆæ¯ï¼ˆæŒ‰ sessionId å“ˆå¸Œï¼‰|
| 7 | **çƒ­ç‚¹ Key** | çƒ­é—¨ç”µå½±è¯¦æƒ…è¢«é«˜é¢‘è®¿é—® | æœ¬åœ°ç¼“å­˜ + Redis é›†ç¾¤åˆ†ç‰‡ + è¯·æ±‚åˆå¹¶ |

### 5.2 æŠ€æœ¯é€‰å‹å†³ç­–

| å†³ç­–ç‚¹ | é€‰é¡¹å¯¹æ¯” | æœ€ç»ˆé€‰æ‹© | ç†ç”± |
|--------|---------|---------|------|
| **IM é•¿è¿æ¥** | Netty vs Spring WebSocket | Spring WebSocket | å¼€å‘æ•ˆç‡é«˜ï¼Œä¸ Spring ç”Ÿæ€é›†æˆå¥½ï¼Œä¸‡çº§è¿æ¥å¤Ÿç”¨ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | Kafka vs RocketMQ vs RabbitMQ | RocketMQ | é˜¿é‡Œç”Ÿæ€ã€æ”¯æŒé¡ºåºæ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€æ­»ä¿¡é˜Ÿåˆ— |
| **æœç´¢å¼•æ“** | ES vs Solr vs Meilisearch | ES 7.6 | ç”Ÿæ€æˆç†Ÿã€æ”¯æŒå‘é‡æ£€ç´¢ã€ä¸ Spring é›†æˆå¥½ |
| **AI æ¡†æ¶** | LangChain4j vs Spring AI | LangChain4j | åŠŸèƒ½æ›´ä¸°å¯Œã€RAG æ”¯æŒå®Œå–„ã€ç¤¾åŒºæ´»è·ƒ |
| **æœ¬åœ°ç¼“å­˜** | Caffeine vs Guava Cache | Caffeine | æ€§èƒ½æ›´ä¼˜ï¼ˆWindow TinyLFUï¼‰ã€Guava ä½œè€…æ¨è |

---

## å…­ã€å¦‚ä½•å‘é¢è¯•å®˜è®²è¿™ä¸ªé¡¹ç›®

> ğŸ’¡ **ä½¿ç”¨åœºæ™¯**ï¼šè‡ªæˆ‘ä»‹ç»ã€é¡¹ç›®ä»‹ç»ã€æŠ€æœ¯é¢è¯•å¼€åœº

### 6.1 é¡¹ç›®èƒŒæ™¯ï¼ˆ30 ç§’ï¼‰

**è¯æœ¯æ¨¡æ¿ï¼š**

> "æœå†»å½±é™¢æ˜¯ä¸€ä¸ª**å½±è§† + ç¤¾äº¤ + AI**ä¸€ä½“åŒ–çš„å¾®æœåŠ¡å¹³å°ã€‚æ ¸å¿ƒåœºæ™¯æ˜¯ï¼šç”¨æˆ·å¯ä»¥**è¾¹çœ‹å‰§è¾¹èŠå¤©**ï¼Œåœ¨ç¤¾åŒºè®¨è®ºå‰§æƒ…ï¼Œè¿˜èƒ½é€šè¿‡**AI åŠ©æ‰‹è·å–å‰§é€æˆ–ç”ŸæˆåŒäººå°è¯´**ã€‚
> 
> è¿™ä¸ªé¡¹ç›®è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šä¼ ç»Ÿè§†é¢‘ç½‘ç«™åªæœ‰å•å‘å†…å®¹æ¶ˆè´¹ï¼Œç¼ºä¹ç¤¾äº¤äº’åŠ¨ï¼›è€Œæˆ‘ä»¬é€šè¿‡**å®æ—¶é€šè®¯ + AI èƒ½åŠ›**ï¼Œæ„å»ºäº†ä¸€ä¸ªæœ‰æ¸©åº¦çš„å½±è§†ç¤¾åŒºã€‚"

**å…³é”®è¯æç‚¼ï¼š**
- å½±è§† + ç¤¾äº¤ + AI
- è¾¹çœ‹è¾¹èŠ
- å¾®æœåŠ¡æ¶æ„

---

### 6.2 æ¶æ„é€‰æ‹©ä¾æ®ï¼ˆ1 åˆ†é’Ÿï¼‰

**è¯æœ¯æ¨¡æ¿ï¼š**

> "æŠ€æœ¯é€‰å‹ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨ **Spring Cloud Alibaba** å¾®æœåŠ¡ä½“ç³»ï¼š
> 
> 1. **ä¸ºä»€ä¹ˆå¾®æœåŠ¡ï¼Ÿ** ä¸šåŠ¡æ¨¡å—ï¼ˆå½±è§†ã€IMã€ç¤¾åŒºã€AIï¼‰è¾¹ç•Œæ¸…æ™°ï¼Œç‹¬ç«‹æ¼”è¿›éœ€æ±‚å¼º
> 2. **ä¸ºä»€ä¹ˆ Nacosï¼Ÿ** ç»Ÿä¸€æ³¨å†Œå‘ç° + é…ç½®ä¸­å¿ƒï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼Œè¿ç»´æˆæœ¬ä½
> 3. **ä¸ºä»€ä¹ˆ RocketMQï¼Ÿ** IM åœºæ™¯éœ€è¦é«˜ååã€ä½å»¶è¿Ÿï¼Œä¸”éœ€è¦é¡ºåºæ¶ˆæ¯ä¿è¯
> 4. **ä¸ºä»€ä¹ˆ LangChain4jï¼Ÿ** åŸç”Ÿ Java ç”Ÿæ€ï¼Œæ¯” Python æ–¹æ¡ˆæ€§èƒ½æ›´å¥½ï¼Œä¸ Spring é›†æˆæ›´é¡ºç•…"

---

### 6.3 æµé‡é«˜å³°å¦‚ä½•å¤„ç†ï¼ˆ1 åˆ†é’Ÿï¼‰

**è¯æœ¯æ¨¡æ¿ï¼š**

> "é’ˆå¯¹æµé‡é«˜å³°ï¼Œæˆ‘ä»¬è®¾è®¡äº†**ä¸‰å±‚é˜²æŠ¤**ï¼š
> 
> **ç¬¬ä¸€å±‚ï¼šç½‘å…³é™æµ**
> - Sentinel Gateway Flow æŒ‰è·¯ç”±é™æµ
> - AI æ¥å£å•ç‹¬é™åˆ¶ QPSï¼ˆæˆæœ¬æ§åˆ¶ï¼‰
> 
> **ç¬¬äºŒå±‚ï¼šæœåŠ¡ç†”æ–­**
> - Feign + Sentinel ç†”æ–­é™çº§
> - AI æœåŠ¡æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æä¾›å•†
> 
> **ç¬¬ä¸‰å±‚ï¼šå¼‚æ­¥å‰Šå³°**
> - IM æ¶ˆæ¯é€šè¿‡ RocketMQ å¼‚æ­¥æŒä¹…åŒ–
> - çƒ­é—¨æ¦œå•èµ° Redis ZSetï¼Œé¿å…æ•°æ®åº“å‹åŠ›"

### 6.4 æ•…éšœåœºæ™¯å¦‚ä½•å…œåº•ï¼ˆ1 åˆ†é’Ÿï¼‰

**è¯æœ¯æ¨¡æ¿ï¼š**

> "æˆ‘ä»¬è®¾è®¡äº†**å¤šå±‚å…œåº•ç­–ç•¥**ï¼š
> 
> | æ•…éšœåœºæ™¯ | å…œåº•æ–¹æ¡ˆ |
> |---------|---------|
> | Redis å®•æœº | Fallback åˆ° MySQL æŸ¥è¯¢ + æœ¬åœ°ç¼“å­˜å…œåº• |
> | AI æœåŠ¡è¶…æ—¶ | è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æä¾›å•† + è¿”å›å‹å¥½æç¤º |
> | æ¶ˆæ¯é˜Ÿåˆ—å †ç§¯ | æ¶ˆè´¹è€…æ°´å¹³æ‰©å®¹ + æ¶ˆæ¯ TTL è‡ªåŠ¨è¿‡æœŸ |
> | ES ä¸å¯ç”¨ | é™çº§åˆ° MySQL LIKE æŸ¥è¯¢ |
> 
> æ ¸å¿ƒåŸåˆ™æ˜¯ï¼š**æœåŠ¡å¯é™çº§ä½†ä¸å¯ä¸ç”¨**ï¼Œä¿è¯æ ¸å¿ƒé“¾è·¯å¯ç”¨æ€§ã€‚"

---

### 6.5 å¯æ‰©å±•æ€§è®¾è®¡ï¼ˆ30 ç§’ï¼‰

**è¯æœ¯æ¨¡æ¿ï¼š**

> "å¯æ‰©å±•æ€§ä½“ç°åœ¨å‡ ä¸ªæ–¹é¢ï¼š
> 
> 1. **æ°´å¹³æ‰©å±•**ï¼šæ‰€æœ‰æœåŠ¡æ— çŠ¶æ€è®¾è®¡ï¼Œæ”¯æŒ K8s å¼¹æ€§ä¼¸ç¼©
> 2. **æ•°æ®åˆ†ç‰‡**ï¼šæ¶ˆæ¯è¡¨æŒ‰æ—¶é—´åˆ†è¡¨ï¼Œç”¨æˆ·æ•°æ®å¯æŒ‰ ID åˆ†åº“
> 3. **AI æ‰©å±•**ï¼šå¤šæä¾›å•†æ¶æ„ï¼Œæ–°å¢æ¨¡å‹åªéœ€é…ç½®æ–‡ä»¶
> 4. **åŠŸèƒ½æ‰©å±•**ï¼šé¢„ç•™äº†æ¨èç®—æ³•æ¥å£ï¼Œæ”¯æŒåç»­æ¥å…¥ä¸ªæ€§åŒ–æ¨èå¼•æ“"

---

### 6.6 é¢è¯•è¡¨è¾¾ Checklist

```
âœ… å¼€åœºï¼ˆ30ç§’ï¼‰
   â–¡ é¡¹ç›®åç§° + ä¸€å¥è¯å®šä½
   â–¡ æ ¸å¿ƒåœºæ™¯ï¼ˆè¾¹çœ‹è¾¹èŠ + AI åŠ©æ‰‹ï¼‰
   â–¡ è§£å†³çš„é—®é¢˜ï¼ˆå†…å®¹æ¶ˆè´¹ â†’ ç¤¾äº¤äº’åŠ¨ï¼‰

âœ… æ¶æ„ï¼ˆ1åˆ†é’Ÿï¼‰
   â–¡ å¾®æœåŠ¡åˆ’åˆ†ï¼ˆ6 ä¸ªæœåŠ¡ï¼‰
   â–¡ æŠ€æœ¯é€‰å‹ä¾æ®ï¼ˆNacos/RocketMQ/LangChain4jï¼‰
   â–¡ ç”»å‡ºç®€å•æ¶æ„å›¾ï¼ˆå¦‚æœæœ‰ç™½æ¿ï¼‰

âœ… äº®ç‚¹ï¼ˆ2åˆ†é’Ÿï¼‰
   â–¡ å¤šçº§ç¼“å­˜ï¼ˆCaffeine + Redisï¼‰
   â–¡ å®æ—¶é€šè®¯ï¼ˆWebSocket + MQ å‰Šå³°ï¼‰
   â–¡ AI æ•…éšœè½¬ç§»ï¼ˆå¤šæä¾›å•† + ç†”æ–­ï¼‰
   â–¡ ES æ··åˆæœç´¢ï¼ˆBM25 + å‘é‡ï¼‰

âœ… éš¾ç‚¹ï¼ˆ1åˆ†é’Ÿï¼‰
   â–¡ é€‰ä¸€ä¸ªæœ€æœ‰æ·±åº¦çš„éš¾ç‚¹
   â–¡ é—®é¢˜ â†’ åˆ†æ â†’ æ–¹æ¡ˆ â†’ æ•ˆæœ
   â–¡ ä½“ç°è§£å†³é—®é¢˜çš„æ€è·¯

âœ… æ”¶å°¾ï¼ˆ30ç§’ï¼‰
   â–¡ é¡¹ç›®æˆæœï¼ˆæ•°æ®æŒ‡æ ‡ï¼‰
   â–¡ ä¸ªäººæ”¶è·ï¼ˆæŠ€æœ¯æˆé•¿ï¼‰
   â–¡ å¼•å¯¼é¢è¯•å®˜æé—®
```

---

## ä¸ƒã€é™„å½•

### 7.1 æŠ€æœ¯æ ˆç‰ˆæœ¬æ¸…å•

| åˆ†ç±» | ç»„ä»¶ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **åŸºç¡€æ¡†æ¶** | Spring Boot | 3.2+ | åº”ç”¨åŸºç¡€æ¡†æ¶ |
| | Spring Cloud Alibaba | 2022.x | å¾®æœåŠ¡æ²»ç†å¥—ä»¶ |
| **æœåŠ¡æ²»ç†** | Nacos | 2.x | æ³¨å†Œä¸­å¿ƒ & é…ç½®ä¸­å¿ƒ |
| | Sentinel | 1.8.x | é™æµç†”æ–­ |
| | OpenFeign | 4.x | å£°æ˜å¼ HTTP å®¢æˆ·ç«¯ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RocketMQ | 4.9.x | å¼‚æ­¥æ¶ˆæ¯ã€å‰Šå³°å¡«è°· |
| **æ•°æ®å­˜å‚¨** | MySQL | 8.0+ | å…³ç³»å‹æ•°æ®åº“ |
| | Redis | 6.2+ | åˆ†å¸ƒå¼ç¼“å­˜ã€ä¼šè¯å­˜å‚¨ |
| | Elasticsearch | 7.6.x | å…¨æ–‡æœç´¢ã€å‘é‡æ£€ç´¢ |
| | MinIO | Latest | å¯¹è±¡å­˜å‚¨ï¼ˆå›¾ç‰‡/æ–‡ä»¶ï¼‰|
| **AI é›†æˆ** | LangChain4j | 0.34+ | LLM é›†æˆæ¡†æ¶ |
| | BGE-M3 | - | Embedding å‘é‡æ¨¡å‹ |
| **è®¤è¯æˆæƒ** | Sa-Token | 1.37+ | è½»é‡çº§è®¤è¯æ¡†æ¶ |
| **ORM** | MyBatis Plus | 3.5+ | æ•°æ®è®¿é—®å±‚ |
| **æœ¬åœ°ç¼“å­˜** | Caffeine | 3.x | é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜ |
| **å·¥å…·åº“** | Hutool | 5.8+ | Java å·¥å…·ç±»åº“ |
| **å‰ç«¯** | Vue | 3.x | å‰ç«¯æ¡†æ¶ |
| | Element Plus | 2.x | UI ç»„ä»¶åº“ |
| | TailwindCSS | 3.x | CSS æ¡†æ¶ |
| | Pinia | 2.x | çŠ¶æ€ç®¡ç† |

### 7.2 é¡¹ç›®ç»“æ„

```
jelly-cinema-v2/
â”œâ”€â”€ jelly-gateway/           # API ç½‘å…³ (Port: 8080)
â”‚   â”œâ”€â”€ filter/              # å…¨å±€è¿‡æ»¤å™¨ï¼ˆè®¤è¯ã€é™æµï¼‰
â”‚   â””â”€â”€ config/              # ç½‘å…³é…ç½®
â”œâ”€â”€ jelly-auth/              # è®¤è¯æœåŠ¡ (Port: 9100)
â”‚   â”œâ”€â”€ controller/          # ç™»å½•ã€æ³¨å†Œã€Token ç®¡ç†
â”‚   â””â”€â”€ service/             # è®¤è¯ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ jelly-modules/
â”‚   â”œâ”€â”€ jelly-film/          # ç”µå½±æœåŠ¡ (Port: 9200)
â”‚   â”‚   â”œâ”€â”€ service/         # ç”µå½±ã€åˆ†ç±»ã€æ”¶è—
â”‚   â”‚   â””â”€â”€ ElasticSearchService  # ES æœç´¢
â”‚   â”œâ”€â”€ jelly-community/     # ç¤¾åŒºæœåŠ¡ (Port: 9300)
â”‚   â”‚   â”œâ”€â”€ controller/      # å¸–å­ã€è¯„è®ºã€æŠ•ç¥¨
â”‚   â”‚   â””â”€â”€ service/         # ç¤¾åŒºä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ jelly-im/            # IM æœåŠ¡ (Port: 9400)
â”‚   â”‚   â”œâ”€â”€ websocket/       # WebSocket Handler
â”‚   â”‚   â”œâ”€â”€ mq/              # RocketMQ Producer/Consumer
â”‚   â”‚   â””â”€â”€ service/         # æ¶ˆæ¯ã€å¥½å‹ã€ç¾¤ç»„
â”‚   â”œâ”€â”€ jelly-ai/            # AI æœåŠ¡ (Port: 9500)
â”‚   â”‚   â”œâ”€â”€ config/          # å¤šæä¾›å•†é…ç½®ã€ç†”æ–­
â”‚   â”‚   â””â”€â”€ service/         # Chatã€RAGã€Novel
â”‚   â””â”€â”€ jelly-admin/         # ç®¡ç†æœåŠ¡ (Port: 9600)
â”œâ”€â”€ jelly-common/            # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ jelly-common-core/   # æ ¸å¿ƒå·¥å…·ã€å¼‚å¸¸ã€å“åº”
â”‚   â”œâ”€â”€ jelly-common-redis/  # Redis æ“ä½œå°è£…
â”‚   â”œâ”€â”€ jelly-common-mybatis/# MyBatis é…ç½®
â”‚   â”œâ”€â”€ jelly-common-security/# å®‰å…¨è®¤è¯
â”‚   â””â”€â”€ jelly-common-oss/    # å¯¹è±¡å­˜å‚¨
â”œâ”€â”€ jelly-ui-web/            # å‰ç«¯é¡¹ç›® (Vue3)
â”œâ”€â”€ doc/
â”‚   â”œâ”€â”€ sql/                 # æ•°æ®åº“è„šæœ¬
â”‚   â””â”€â”€ é¡¹ç›®äº®ç‚¹å¢å¼ºæ–¹æ¡ˆ.md  # æœ¬æ–‡æ¡£
â””â”€â”€ docker-compose.yml       # Docker ç¼–æ’
```

### 7.3 API æ¥å£æ¸…å•

| æ¨¡å— | ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|------|
| **è®¤è¯** | `/auth/login` | POST | ç”¨æˆ·ç™»å½• |
| | `/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| | `/auth/logout` | POST | é€€å‡ºç™»å½• |
| **ç”µå½±** | `/film/list` | GET | ç”µå½±åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| | `/film/detail/{id}` | GET | ç”µå½±è¯¦æƒ… |
| | `/film/search` | GET | æœç´¢ç”µå½± |
| | `/film/recommend/hot` | GET | çƒ­é—¨æ¦œå• |
| **ç¤¾åŒº** | `/post/list` | GET | å¸–å­åˆ—è¡¨ |
| | `/post/create` | POST | å‘å¸ƒå¸–å­ |
| | `/post/vote/{id}` | POST | æŠ•ç¥¨ï¼ˆèµåŒ/åå¯¹ï¼‰|
| | `/comment/list/{postId}` | GET | è¯„è®ºåˆ—è¡¨ |
| **IM** | `/im/sessions` | GET | ä¼šè¯åˆ—è¡¨ |
| | `/im/history/{sessionId}` | GET | å†å²æ¶ˆæ¯ |
| | `/ws/chat` | WebSocket | å®æ—¶é€šè®¯è¿æ¥ |
| **AI** | `/ai/chat` | POST | åŒæ­¥å¯¹è¯ |
| | `/ai/chat/stream` | POST | æµå¼å¯¹è¯ (SSE) |
| | `/ai/rag/search` | GET | RAG æ£€ç´¢ |

### 7.4 æ€§èƒ½æŒ‡æ ‡å‚è€ƒ

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®æµ‹å€¼ | è¯´æ˜ |
|------|-------|-------|------|
| **API å“åº”æ—¶é—´** | < 100ms | ~50ms | P99 |
| **ç¼“å­˜å‘½ä¸­ç‡** | > 90% | 95%+ | Caffeine + Redis |
| **WebSocket å¹¶å‘** | 10K+ | æµ‹è¯•ç¯å¢ƒ 5K | å•èŠ‚ç‚¹ |
| **ES æœç´¢å»¶è¿Ÿ** | < 100ms | ~30ms | åƒçº§æ–‡æ¡£ |
| **AI é¦–å­—èŠ‚** | < 1s | ~500ms | æµå¼å“åº” |
| **æ¶ˆæ¯å»¶è¿Ÿ** | < 100ms | ~30ms | å‘é€åˆ°æ¥æ”¶ |

---

<div align="center">


æœ€åæ›´æ–°ï¼š2025å¹´12æœˆ

</div>
