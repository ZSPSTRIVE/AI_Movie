<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æœå†»å½±é™¢ - å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .section { background: #fff; border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .section h2 { margin-top: 0; color: #333; border-bottom: 2px solid #409eff; padding-bottom: 10px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeeba; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #409eff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #66b1ff; }
        input, textarea { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .status { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px; }
        .status.ok { background: #67c23a; color: white; }
        .status.fail { background: #f56c6c; color: white; }
        .status.pending { background: #909399; color: white; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        h1 { text-align: center; color: #409eff; }
        .summary { background: #ecf5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .summary-item { display: inline-block; margin: 0 20px; }
    </style>
</head>
<body>
    <h1>ğŸ¬ æœå†»å½±é™¢ - å®Œæ•´åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="summary">
        <strong>æµ‹è¯•ç»Ÿè®¡ï¼š</strong>
        <span class="summary-item">âœ… é€šè¿‡: <span id="passCount">0</span></span>
        <span class="summary-item">âŒ å¤±è´¥: <span id="failCount">0</span></span>
        <span class="summary-item">â³ å¾…æµ‹: <span id="pendingCount">0</span></span>
        <button onclick="runAllTests()" style="float: right;">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearAll()" style="float: right; background: #909399;">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="grid">
        <!-- è®¤è¯æ¨¡å— -->
        <div class="section">
            <h2>ğŸ” è®¤è¯æ¨¡å— <span id="auth-status" class="status pending">å¾…æµ‹</span></h2>
            <div>
                <input id="reg-username" placeholder="ç”¨æˆ·å" value="testuser">
                <input id="reg-password" placeholder="å¯†ç " value="123456">
                <input id="reg-nickname" placeholder="æ˜µç§°" value="æµ‹è¯•ç”¨æˆ·">
            </div>
            <button onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
            <div id="auth-result" class="result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</div>
        </div>

        <!-- ç”µå½±æ¨¡å— -->
        <div class="section">
            <h2>ğŸ¬ ç”µå½±æ¨¡å— <span id="film-status" class="status pending">å¾…æµ‹</span></h2>
            <button onclick="testFilmList()">ç”µå½±åˆ—è¡¨</button>
            <button onclick="testFilmRecommend()">æ¨èç”µå½±</button>
            <button onclick="testFilmHot()">çƒ­é—¨æ¦œå•</button>
            <button onclick="testFilmCategory()">åˆ†ç±»åˆ—è¡¨</button>
            <button onclick="testFilmDetail()">ç”µå½±è¯¦æƒ…</button>
            <div id="film-result" class="result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</div>
        </div>

        <!-- ç¤¾åŒºæ¨¡å— -->
        <div class="section">
            <h2>ğŸ’¬ ç¤¾åŒºæ¨¡å— <span id="community-status" class="status pending">å¾…æµ‹</span></h2>
            <button onclick="testPostList()">å¸–å­åˆ—è¡¨</button>
            <button onclick="testCreatePost()">å‘å¸ƒå¸–å­</button>
            <button onclick="testCommentList()">è¯„è®ºåˆ—è¡¨</button>
            <div id="community-result" class="result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</div>
        </div>

        <!-- AI æ¨¡å— -->
        <div class="section">
            <h2>ğŸ¤– AI æ¨¡å— <span id="ai-status" class="status pending">å¾…æµ‹</span></h2>
            <div>
                <textarea id="ai-prompt" rows="2" cols="30" placeholder="è¾“å…¥é—®é¢˜">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä¸‰ä½“è¿™éƒ¨ç”µè§†å‰§</textarea>
            </div>
            <button onclick="testAiChat()">AI å¯¹è¯</button>
            <button onclick="testNovelOutline()">å°è¯´å¤§çº²</button>
            <div id="ai-result" class="result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</div>
        </div>

        <!-- IM æ¨¡å— -->
        <div class="section">
            <h2>ğŸ“¨ å³æ—¶é€šè®¯ <span id="im-status" class="status pending">å¾…æµ‹</span></h2>
            <button onclick="testImSessions()">ä¼šè¯åˆ—è¡¨</button>
            <button onclick="testWebSocket()">WebSocketè¿æ¥</button>
            <div id="im-result" class="result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</div>
        </div>

        <!-- å·¥å…· -->
        <div class="section">
            <h2>ğŸ› ï¸ å·¥å…·</h2>
            <button onclick="clearStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
            <button onclick="showToken()">æ˜¾ç¤ºå½“å‰Token</button>
            <button onclick="testGateway()">æµ‹è¯•Gateway</button>
            <div id="tool-result" class="result">å·¥å…·ç»“æœ...</div>
        </div>
    </div>

    <script>
        let token = null;
        let passCount = 0;
        let failCount = 0;

        function updateStats() {
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
        }

        function setResult(id, success, message) {
            const el = document.getElementById(id);
            el.className = 'result ' + (success ? 'success' : 'error');
            el.textContent = (success ? 'âœ… ' : 'âŒ ') + message;
        }

        function setStatus(id, status) {
            const el = document.getElementById(id);
            el.className = 'status ' + status;
            el.textContent = status === 'ok' ? 'é€šè¿‡' : status === 'fail' ? 'å¤±è´¥' : 'å¾…æµ‹';
        }

        async function apiCall(url, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = token;
            try {
                const res = await fetch('/api' + url, { ...options, headers });
                const text = await res.text();
                console.log('Response for ' + url + ':', text);
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return { code: res.status, msg: text || 'Empty response', data: null };
                }
            } catch (e) {
                console.error('Fetch error:', e);
                return { code: 500, msg: e.message, data: null };
            }
        }

        // ===== è®¤è¯æµ‹è¯• =====
        async function testRegister() {
            try {
                const username = document.getElementById('reg-username').value + Date.now();
                const password = document.getElementById('reg-password').value;
                const nickname = document.getElementById('reg-nickname').value;
                const data = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, password, confirmPassword: password, nickname })
                });
                if (data.code === 200) {
                    setResult('auth-result', true, 'æ³¨å†ŒæˆåŠŸï¼ç”¨æˆ·å: ' + username);
                    document.getElementById('reg-username').value = username;
                    setStatus('auth-status', 'ok'); passCount++;
                } else {
                    setResult('auth-result', false, 'æ³¨å†Œå¤±è´¥: ' + data.msg);
                    setStatus('auth-status', 'fail'); failCount++;
                }
            } catch (e) {
                setResult('auth-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
                setStatus('auth-status', 'fail'); failCount++;
            }
            updateStats();
        }

        async function testLogin() {
            try {
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                const data = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                if (data.code === 200) {
                    token = data.data.token;
                    setResult('auth-result', true, 'ç™»å½•æˆåŠŸï¼\nToken: ' + token + '\nç”¨æˆ·: ' + data.data.nickname);
                    setStatus('auth-status', 'ok'); passCount++;
                } else {
                    setResult('auth-result', false, 'ç™»å½•å¤±è´¥: ' + data.msg);
                    setStatus('auth-status', 'fail'); failCount++;
                }
            } catch (e) {
                setResult('auth-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
                setStatus('auth-status', 'fail'); failCount++;
            }
            updateStats();
        }

        async function testLogout() {
            try {
                const data = await apiCall('/auth/logout', { method: 'POST' });
                token = null;
                setResult('auth-result', true, 'ç™»å‡ºæˆåŠŸï¼');
            } catch (e) {
                setResult('auth-result', false, 'ç™»å‡ºå¤±è´¥: ' + e.message);
            }
        }

        // ===== ç”µå½±æµ‹è¯• =====
        async function testFilmList() {
            try {
                const data = await apiCall('/film/list?pageNum=1&pageSize=5');
                console.log('Film list response:', data);
                if (data.code === 200) {
                    setResult('film-result', true, 'ç”µå½±åˆ—è¡¨è·å–æˆåŠŸï¼\nå…± ' + data.data.total + ' éƒ¨ç”µå½±\n' + JSON.stringify(data.data.rows?.slice(0, 2), null, 2));
                    setStatus('film-status', 'ok'); passCount++;
                } else {
                    setResult('film-result', false, 'è·å–å¤±è´¥: ' + (data.msg || data.error || JSON.stringify(data)));
                    setStatus('film-status', 'fail'); failCount++;
                }
            } catch (e) {
                setResult('film-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message + '\n' + e.stack);
                setStatus('film-status', 'fail'); failCount++;
            }
            updateStats();
        }

        async function testFilmRecommend() {
            try {
                const data = await apiCall('/film/recommend/feed?size=3');
                if (data.code === 200) {
                    const titles = data.data.map(f => f.title).join(', ');
                    setResult('film-result', true, 'æ¨èç”µå½±è·å–æˆåŠŸï¼\nç”µå½±: ' + titles);
                    setStatus('film-status', 'ok');
                } else {
                    setResult('film-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('film-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function testFilmHot() {
            try {
                const data = await apiCall('/film/recommend/hot?size=3');
                if (data.code === 200) {
                    const titles = data.data.map(f => f.title + '(' + f.playCount + 'æ¬¡)').join(', ');
                    setResult('film-result', true, 'çƒ­é—¨æ¦œå•è·å–æˆåŠŸï¼\n' + titles);
                } else {
                    setResult('film-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('film-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function testFilmCategory() {
            try {
                const data = await apiCall('/film/category/list');
                if (data.code === 200) {
                    const names = data.data.map(c => c.name).join(', ');
                    setResult('film-result', true, 'åˆ†ç±»åˆ—è¡¨è·å–æˆåŠŸï¼\nåˆ†ç±»: ' + names);
                } else {
                    setResult('film-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('film-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function testFilmDetail() {
            try {
                const data = await apiCall('/film/detail/1001');
                if (data.code === 200) {
                    setResult('film-result', true, 'ç”µå½±è¯¦æƒ…è·å–æˆåŠŸï¼\n' + data.data.title + ' - ' + data.data.description?.slice(0, 50) + '...');
                } else {
                    setResult('film-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('film-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        // ===== ç¤¾åŒºæµ‹è¯• =====
        async function testPostList() {
            try {
                const data = await apiCall('/post/list?pageNum=1&pageSize=5');
                if (data.code === 200) {
                    setResult('community-result', true, 'å¸–å­åˆ—è¡¨è·å–æˆåŠŸï¼\nå…± ' + data.data.total + ' ä¸ªå¸–å­');
                    setStatus('community-status', 'ok'); passCount++;
                } else {
                    setResult('community-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                    setStatus('community-status', 'fail'); failCount++;
                }
            } catch (e) {
                setResult('community-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
                setStatus('community-status', 'fail'); failCount++;
            }
            updateStats();
        }

        async function testCreatePost() {
            if (!token) {
                setResult('community-result', false, 'è¯·å…ˆç™»å½•ï¼');
                return;
            }
            try {
                const data = await apiCall('/post/create', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: 'æµ‹è¯•å¸–å­ ' + new Date().toLocaleString(),
                        contentHtml: '<p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¸–å­å†…å®¹</p>'
                    })
                });
                if (data.code === 200) {
                    setResult('community-result', true, 'å‘å¸ƒå¸–å­æˆåŠŸï¼å¸–å­ID: ' + data.data);
                } else {
                    setResult('community-result', false, 'å‘å¸ƒå¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('community-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        async function testCommentList() {
            try {
                const data = await apiCall('/comment/list/1?pageNum=1&pageSize=5');
                if (data.code === 200) {
                    setResult('community-result', true, 'è¯„è®ºåˆ—è¡¨è·å–æˆåŠŸï¼\nå…± ' + data.data.total + ' æ¡è¯„è®º');
                } else {
                    setResult('community-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('community-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        // ===== AI æµ‹è¯• =====
        async function testAiChat() {
            try {
                const prompt = document.getElementById('ai-prompt').value;
                setResult('ai-result', true, 'æ­£åœ¨è¯·æ±‚ AI...');
                const data = await apiCall('/ai/chat', {
                    method: 'POST',
                    body: JSON.stringify({ prompt, enableRag: false })
                });
                console.log('AI chat response:', data);
                if (data.code === 200) {
                    setResult('ai-result', true, 'AI å¯¹è¯æˆåŠŸï¼\nå›å¤: ' + data.data);
                    setStatus('ai-status', 'ok'); passCount++;
                } else {
                    setResult('ai-result', false, 'AI å¯¹è¯å¤±è´¥: ' + (data.msg || data.error || 'Unknown error') + '\nå®Œæ•´å“åº”:\n' + JSON.stringify(data, null, 2));
                    setStatus('ai-status', 'fail'); failCount++;
                }
            } catch (e) {
                setResult('ai-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
                setStatus('ai-status', 'fail'); failCount++;
            }
            updateStats();
        }

        async function testNovelOutline() {
            if (!token) {
                setResult('ai-result', false, 'è¯·å…ˆç™»å½•ï¼');
                return;
            }
            try {
                setResult('ai-result', true, 'æ­£åœ¨ç”Ÿæˆå°è¯´å¤§çº²...');
                const data = await apiCall('/ai/novel/generate-outline', {
                    method: 'POST',
                    body: JSON.stringify({ theme: 'ç§‘å¹»å†’é™©', chapterCount: 3 })
                });
                if (data.code === 200) {
                    setResult('ai-result', true, 'å°è¯´å¤§çº²ç”ŸæˆæˆåŠŸï¼\n' + data.data?.slice(0, 500) + '...');
                } else {
                    setResult('ai-result', false, 'ç”Ÿæˆå¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                setResult('ai-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        // ===== IM æµ‹è¯• =====
        async function testImSessions() {
            if (!token) {
                setResult('im-result', false, 'è¯·å…ˆç™»å½•ï¼');
                return;
            }
            try {
                const data = await apiCall('/im/sessions');
                if (data.code === 200) {
                    setResult('im-result', true, 'ä¼šè¯åˆ—è¡¨è·å–æˆåŠŸï¼\nå…± ' + (data.data?.length || 0) + ' ä¸ªä¼šè¯');
                    setStatus('im-status', 'ok'); passCount++;
                } else {
                    setResult('im-result', false, 'è·å–å¤±è´¥: ' + data.msg);
                    setStatus('im-status', 'fail'); failCount++;
                }
            } catch (e) {
                setResult('im-result', false, 'è¯·æ±‚å¤±è´¥: ' + e.message);
                setStatus('im-status', 'fail'); failCount++;
            }
            updateStats();
        }

        async function testWebSocket() {
            if (!token) {
                setResult('im-result', false, 'è¯·å…ˆç™»å½•ï¼');
                return;
            }
            try {
                const ws = new WebSocket('ws://localhost:8080/ws/chat?token=' + token);
                ws.onopen = () => {
                    setResult('im-result', true, 'WebSocket è¿æ¥æˆåŠŸï¼');
                    setStatus('im-status', 'ok');
                    ws.close();
                };
                ws.onerror = (e) => {
                    setResult('im-result', false, 'WebSocket è¿æ¥å¤±è´¥ï¼');
                    setStatus('im-status', 'fail');
                };
            } catch (e) {
                setResult('im-result', false, 'WebSocket é”™è¯¯: ' + e.message);
            }
        }

        // ===== å·¥å…· =====
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            token = null;
            setResult('tool-result', true, 'å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨ï¼');
        }

        function showToken() {
            setResult('tool-result', token ? true : false, token ? 'Token: ' + token : 'æœªç™»å½•ï¼Œæ²¡æœ‰ Token');
        }

        async function testGateway() {
            try {
                const res = await fetch('http://localhost:8080/film/recommend/feed?size=1');
                const data = await res.json();
                setResult('tool-result', true, 'Gateway æ­£å¸¸ï¼\n' + JSON.stringify(data, null, 2));
            } catch (e) {
                setResult('tool-result', false, 'Gateway è®¿é—®å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ CORSï¼‰: ' + e.message);
            }
        }

        // ===== è¿è¡Œæ‰€æœ‰æµ‹è¯• =====
        async function runAllTests() {
            passCount = 0; failCount = 0;
            
            // å…ˆæ³¨å†Œç™»å½•
            await testRegister();
            await new Promise(r => setTimeout(r, 500));
            await testLogin();
            await new Promise(r => setTimeout(r, 500));
            
            // æµ‹è¯•å„æ¨¡å—
            await testFilmList();
            await testPostList();
            await testAiChat();
            await testImSessions();
            
            updateStats();
            alert('æµ‹è¯•å®Œæˆï¼é€šè¿‡: ' + passCount + ', å¤±è´¥: ' + failCount);
        }

        function clearAll() {
            passCount = 0; failCount = 0;
            updateStats();
            document.querySelectorAll('.result').forEach(el => {
                el.className = 'result';
                el.textContent = 'ç‚¹å‡»æŒ‰é’®æµ‹è¯•...';
            });
            document.querySelectorAll('.status').forEach(el => {
                el.className = 'status pending';
                el.textContent = 'å¾…æµ‹';
            });
        }
    </script>
</body>
</html>
