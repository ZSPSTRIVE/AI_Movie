# 登录注册验证码系统实现方案

## 概述

本文档详细说明登录注册功能中 **图片验证码** 和 **邮箱数字验证码** 的实现方案。

---

## 一、功能概述

### 1.1 图片验证码
- **用途**：登录界面防止机器人暴力破解
- **技术**：Kaptcha 图片验证码生成库
- **存储**：Redis 缓存，2分钟有效期

### 1.2 邮箱数字验证码
- **用途**：
  - 用户注册时验证邮箱真实性
  - 登录异常时的双重验证（连续3次密码错误触发）
- **技术**：Spring Boot Mail + QQ邮箱 SMTP
- **格式**：6位随机数字
- **有效期**：5分钟

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Vue3)                          │
├─────────────────────────────────────────────────────────────┤
│  登录页面                     │  注册页面                    │
│  ├── 用户名/密码              │  ├── 用户名                  │
│  ├── 图片验证码 ✓             │  ├── 邮箱 ✓                  │
│  └── 邮箱验证码（异常时）      │  ├── 邮箱验证码 ✓            │
│                               │  ├── 图片验证码（发送前）     │
│                               │  └── 密码                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     后端 (Spring Boot)                      │
├─────────────────────────────────────────────────────────────┤
│  jelly-auth 模块                                            │
│  ├── AuthController          (认证接口)                     │
│  ├── AuthService             (认证业务逻辑)                  │
│  └── CaptchaController       (验证码接口)                   │
├─────────────────────────────────────────────────────────────┤
│  jelly-common-captcha 模块                                  │
│  ├── CaptchaService          (图片验证码服务)               │
│  ├── EmailService            (邮件发送服务)                 │
│  └── MailProperties          (邮件配置)                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        存储层                               │
├─────────────────────────────────────────────────────────────┤
│  Redis                       │  MySQL                       │
│  ├── 图片验证码              │  ├── 用户表 (t_user)         │
│  ├── 邮箱验证码              │  └── email 字段              │
│  ├── 发送频率限制            │                              │
│  ├── 每日发送计数            │                              │
│  └── 登录失败计数            │                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、详细流程

### 3.1 登录流程（含图片验证码）

```
┌──────────┐     1. 请求图片验证码      ┌──────────┐
│   用户   │ ──────────────────────────▶│   后端   │
│          │◀────────────────────────── │          │
└──────────┘     返回 Base64 图片        └──────────┘
     │                                        │
     │ 2. 输入账号、密码、验证码              │ 存入 Redis
     │                                        │ key: jelly:captcha:image:{uuid}
     ▼                                        │ expire: 2分钟
┌──────────┐     3. 提交登录请求        ┌──────────┐
│   用户   │ ──────────────────────────▶│   后端   │
│          │                            │          │
└──────────┘                            └──────────┘
                                              │
                   ┌──────────────────────────┼──────────────────────────┐
                   │                          │                          │
                   ▼                          ▼                          ▼
            4a. 验证图片验证码        4b. 查询用户            4c. 检查登录失败次数
               (Redis 比对)              (MySQL)                 (Redis)
                   │                          │                          │
                   │                          │                          │
                   ▼                          ▼                          ▼
            验证码正确？              用户存在？              失败次数 >= 3？
              │    │                  │    │                    │    │
              │是  │否                │是  │否                  │是  │否
              │    │                  │    │                    │    │
              │    └─▶ 返回错误        │    └─▶ 返回错误         │    └─▶ 正常登录
              │                       │                         │
              └───────────────────────┼─────────────────────────┘
                                      │
                                      ▼
                               需要邮箱验证？
                                 │    │
                                 │是  │否
                                 │    │
                                 ▼    ▼
                        要求输入邮箱验证码   验证密码
                                              │
                                              ▼
                                        登录成功
```

### 3.2 注册流程（含邮箱验证码）

```
┌──────────┐     1. 请求图片验证码      ┌──────────┐
│   用户   │ ──────────────────────────▶│   后端   │
│          │◀────────────────────────── │          │
└──────────┘     返回 Base64 图片        └──────────┘
     │
     │ 2. 输入邮箱 + 图片验证码
     │
     ▼
┌──────────┐     3. 请求发送邮箱验证码   ┌──────────┐
│   用户   │ ──────────────────────────▶│   后端   │
│          │                            │          │
└──────────┘                            └──────────┘
                                              │
                   ┌──────────────────────────┼──────────────────────────┐
                   │                          │                          │
                   ▼                          ▼                          ▼
            验证图片验证码            检查发送频率              检查每日限制
                   │                   (60秒间隔)               (10次/天)
                   │                          │                          │
                   └──────────────────────────┼──────────────────────────┘
                                              │
                                              ▼
                                        生成6位数字验证码
                                              │
                   ┌──────────────────────────┼──────────────────────────┐
                   │                          │                          │
                   ▼                          ▼                          ▼
            存入 Redis                 异步发送邮件              刷新图片验证码
       key: jelly:captcha:email:       (SMTP QQ邮箱)
            register:{email}
       expire: 5分钟
                                              │
                                              ▼
┌──────────┐     4. 返回发送成功        ┌──────────┐
│   用户   │◀────────────────────────── │   后端   │
│          │                            │          │
└──────────┘                            └──────────┘
     │
     │ 5. 填写完整注册信息 + 邮箱验证码
     │
     ▼
┌──────────┐     6. 提交注册请求        ┌──────────┐
│   用户   │ ──────────────────────────▶│   后端   │
│          │                            │          │
└──────────┘                            └──────────┘
                                              │
                   ┌──────────────────────────┼──────────────────────────┐
                   │                          │                          │
                   ▼                          ▼                          ▼
            验证邮箱验证码            检查用户名唯一            检查邮箱唯一
                   │                          │                          │
                   └──────────────────────────┼──────────────────────────┘
                                              │
                                              ▼
                                         创建用户
                                              │
                                              ▼
┌──────────┐     7. 返回注册成功        ┌──────────┐
│   用户   │◀────────────────────────── │   后端   │
│          │                            │          │
└──────────┘                            └──────────┘
```

---

## 四、安全措施

### 4.1 图片验证码安全
| 措施 | 说明 |
|------|------|
| 一次性使用 | 验证后立即从 Redis 删除 |
| 短有效期 | 2分钟过期 |
| 干扰元素 | 阴影、噪点、扭曲 |
| 大小写不敏感 | 提升用户体验 |

### 4.2 邮箱验证码安全
| 措施 | 说明 |
|------|------|
| 发送频率限制 | 同一邮箱60秒间隔 |
| 每日发送限制 | 同一邮箱每天最多10次 |
| 验证码有效期 | 5分钟过期 |
| 错误次数限制 | 连续5次错误锁定30分钟 |
| 发送前图片验证 | 防止滥发（可选） |

### 4.3 登录安全
| 措施 | 说明 |
|------|------|
| 密码加密 | BCrypt 加密存储 |
| 失败次数记录 | Redis 记录24小时内失败次数 |
| 邮箱二次验证 | 连续3次失败触发 |
| Token 管理 | Sa-Token 框架 |

### 4.4 敏感信息保护
```yaml
# 配置文件使用环境变量
mail:
  password: ${MAIL_PASSWORD:***}  # 授权码不硬编码
```

---

## 五、接口说明

### 5.1 图片验证码接口
```http
GET /auth/captcha

Response:
{
  "code": 200,
  "data": {
    "captchaKey": "abc123...",
    "captchaImage": "data:image/png;base64,...",
    "expireSeconds": 120
  }
}
```

### 5.2 发送邮箱验证码接口
```http
POST /auth/email/code
Content-Type: application/json

{
  "email": "user@example.com",
  "businessType": "register",  // register | login | reset_password
  "captcha": "ab12",           // 图片验证码（可选）
  "captchaKey": "abc123..."    // 图片验证码Key（可选）
}

Response:
{
  "code": 200,
  "msg": "success"
}
```

### 5.3 登录接口
```http
POST /auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "123456",
  "captcha": "ab12",
  "captchaKey": "abc123...",
  "emailCode": "123456"  // 异常登录时需要
}

Response:
{
  "code": 200,
  "data": {
    "userId": "123",
    "username": "testuser",
    "token": "xxx",
    "expireIn": 86400
  }
}
```

### 5.4 注册接口
```http
POST /auth/register
Content-Type: application/json

{
  "username": "newuser",
  "email": "user@example.com",
  "emailCode": "123456",
  "password": "123456",
  "confirmPassword": "123456",
  "nickname": "昵称"
}

Response:
{
  "code": 200,
  "msg": "success"
}
```

---

## 六、配置说明

### 6.1 邮箱配置 (application.yml)
```yaml
mail:
  from: ${MAIL_FROM:your_email@qq.com}      # 发件人邮箱
  password: ${MAIL_PASSWORD:授权码}          # QQ邮箱授权码
  host: ${MAIL_HOST:smtp.qq.com}            # SMTP服务器
  port: ${MAIL_PORT:465}                    # SSL端口
  admin: ${ADMIN_MAIL:admin@qq.com}         # 管理员邮箱
  ssl: true                                  # 启用SSL
  code-expire-seconds: 300                   # 验证码有效期(秒)
  send-interval-seconds: 60                  # 发送间隔(秒)
  daily-limit: 10                            # 每日发送限制
```

### 6.2 获取QQ邮箱授权码
1. 登录 QQ 邮箱 → 设置 → 账户
2. 开启 POP3/SMTP 服务
3. 生成授权码（非登录密码）

---

## 七、Redis Key 设计

| Key Pattern | 说明 | TTL |
|-------------|------|-----|
| `jelly:captcha:image:{uuid}` | 图片验证码 | 2分钟 |
| `jelly:captcha:email:{type}:{email}` | 邮箱验证码 | 5分钟 |
| `jelly:captcha:rate:email:{email}` | 发送频率限制 | 60秒 |
| `jelly:captcha:daily:email:{date}:{email}` | 每日发送计数 | 当天结束 |
| `jelly:captcha:error:{email}:{type}` | 验证码错误次数 | 30分钟 |
| `jelly:auth:login:fail:{username}` | 登录失败次数 | 24小时 |

---

## 八、文件结构

```
jelly-common-captcha/
├── pom.xml
└── src/main/java/com/jelly/cinema/common/captcha/
    ├── config/
    │   ├── CaptchaAutoConfiguration.java    # 自动配置
    │   └── MailProperties.java              # 邮件配置属性
    ├── constant/
    │   └── CaptchaConstants.java            # 常量定义
    ├── controller/
    │   └── CaptchaController.java           # 验证码控制器
    ├── domain/
    │   ├── CaptchaVO.java                   # 验证码响应
    │   └── EmailCodeDTO.java                # 邮件请求
    └── service/
        ├── CaptchaService.java              # 图片验证码服务
        └── EmailService.java                # 邮件服务
```

---

## 九、邮件模板预览

验证码邮件采用 HTML 格式，包含：
- 果冻影院品牌标识
- 操作类型说明
- 6位数字验证码（突出显示）
- 有效期提示
- 安全提醒

---

## 十、测试建议

1. **图片验证码测试**
   - 正确验证码登录
   - 错误验证码登录
   - 过期验证码登录
   - 验证码大小写不敏感

2. **邮箱验证码测试**
   - 正常发送验证码
   - 60秒内重复发送
   - 每日限制测试
   - 验证码过期测试
   - 错误次数锁定测试

3. **安全测试**
   - 暴力破解测试
   - 验证码重放攻击
   - 邮件滥发测试
